import{j as e}from"./ui-UIpCtT3r.js";import{r as o}from"./vendor-vA4cx1mx.js";import{C as te}from"./calendar-DY_0gfdy.js";import{b as V,i as R,s as b,v as ie,w as ne,x as oe,L as O,y as p,C as w,g as k,m as de,r as ce,c as K,q as J,d as B,e as F,f as Z,z as _,h as le}from"./index-DEm1NP11.js";import{B as q}from"./button-j6LGAhsQ.js";import{S as me}from"./skeleton-DgzSxjFt.js";import{C as U}from"./check-BuvXqBRH.js";import{C as W}from"./clock-CLU1zMjH.js";import{u as ue,d as fe}from"./router-CxXythJb.js";import{C as he}from"./calendar-eMUANn8Q.js";import{C as xe}from"./chevron-right-C68Zab6b.js";import{a as H}from"./addDays-BQ37Zmqx.js";import{f as pe}from"./format-CGvBu07F.js";import{p as ge}from"./pt-BR-Cxqo7XV3.js";import"./en-US-xSPtgCq_.js";import"./endOfMonth-CH6FLORf.js";import"./isSameDay-BJjwZdUf.js";import"./subDays-K6OA95hK.js";import"./chevron-left-CloxnyG4.js";function je({providerId:f,date:c,service:r,onTimeSlotSelect:C,selectedTimeSlot:a}){console.log("TimeSlotSelector RENDERIZADO",{providerId:f,date:c,service:r});const[u,l]=o.useState([]),[T,m]=o.useState(!1),[N,S]=o.useState(!1),[i,I]=o.useState(null),[v,y]=o.useState([]),{toast:g}=V();console.log("TimeSlotSelector - timeSlots:",u),o.useEffect(()=>{r&&a&&C(void 0)},[r]);const D=o.useCallback(async()=>{if(!(!f||!c)){m(!0);try{const s=await R("GET",`/api/providers/${f}/schedule`);if(!s.ok)throw new Error("Failed to load provider schedule");const n=await s.json();I(n.schedule);const d=await R("GET",`/api/bookings?providerId=${f}&date=${c}`);if(!d.ok)throw new Error("Failed to load existing bookings");const t=await d.json();y(t.bookings||[])}catch{g({title:"Error",description:"Could not load provider availability",variant:"destructive"})}finally{m(!1)}}},[f,c,g]);o.useEffect(()=>{D()},[D]);const P=o.useCallback(s=>{if(!s||!s.startTime||!i)return!1;const n=(r==null?void 0:r.durationMinutes)||i.timeSlotInterval;return s.endTime||b(s.startTime,n),s.isAvailable===!0&&ie(s,i,n)&&ne(s,i.blockedSlots,c,n)&&oe(s,v,n)},[i,v,r,c]);o.useEffect(()=>{if(!f||!c||!i)return;(async()=>{m(!0);try{const n=`/api/providers/${f}/time-slots?date=${c}&duration=${(r==null?void 0:r.durationMinutes)||30}`,t=await(await R("GET",n)).json();console.log("[API] /api/providers/:id/time-slots - RESPOSTA:",t);const x=Array.isArray(t)?t:t.timeSlots||[],A=new Date().toISOString().split("T")[0],E=new Date,ae=x.filter(j=>{if(c===A){const[$,re]=j.startTime.split(":").map(Number),Q=new Date;return Q.setHours($,re,0,0),Q>E}return!0}).map(j=>{const $=(r==null?void 0:r.durationMinutes)||i.timeSlotInterval;return{...j,endTime:j.endTime||b(j.startTime,$),formattedSlot:`${p(j.startTime)} - ${p(b(j.startTime,$))}`}}).filter(P);l(ae)}catch{g({title:"Error",description:"Could not load available time slots",variant:"destructive"}),l([])}finally{m(!1)}})()},[f,c,r,i,P,g]);const h=i?i.workingDays.includes(new Date(c).getDay()):!1,L=o.useCallback(s=>{if(!i)return!0;const[n,d]=s==="morning"?["06:00","12:00"]:s==="afternoon"?["12:00","18:00"]:["18:00","23:59"];return!(d<=i.startTime||n>=i.endTime)},[i]),G=async s=>{if(s.isAvailable){S(!0);try{const n=(r==null?void 0:r.durationMinutes)||(i==null?void 0:i.timeSlotInterval)||0,d=s.endTime||b(s.startTime,n);C({...s,endTime:d,formattedSlot:`${p(s.startTime)} - ${p(d)}`})}catch{g({title:"Error",description:"Could not select time slot",variant:"destructive"})}finally{S(!1)}}},X=o.useCallback(s=>{if(!i||!r)return!1;const n=r.durationMinutes+(r.bufferTime||0),d=b(s.startTime,n),t=i.endTime,[x,A]=d.split(":").map(Number),[E,z]=t.split(":").map(Number);return x>E||x===E&&A>z},[i,r]),{morningSlots:Y,afternoonSlots:ee,eveningSlots:se}=o.useMemo(()=>{const s=[],n=[],d=[];return u.forEach(t=>{const x=parseInt(t.startTime.split(":")[0]);x>=6&&x<12?s.push(t):x>=12&&x<18?n.push(t):d.push(t)}),{morningSlots:s,afternoonSlots:n,eveningSlots:d}},[u]);if(T)return e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:Array.from({length:8}).map((s,n)=>e.jsx(me,{className:"h-10 w-full"},n))})});if(!i)return u.length>0?e.jsx("div",{className:"space-y-2",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:u.map(s=>e.jsx(q,{variant:(a==null?void 0:a.startTime)===s.startTime?"default":"outline",size:"sm",className:"justify-start relative",onClick:()=>G(s),disabled:N,children:N&&(a==null?void 0:a.startTime)===s.startTime?e.jsx(O,{className:"h-4 w-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"flex-1 text-center",children:[p(s.startTime),s.endTime&&` - ${p(s.endTime)}`]}),(a==null?void 0:a.startTime)===s.startTime&&e.jsx(U,{className:"h-4 w-4 absolute right-2"})]})},`${s.startTime}-${s.availabilityId||""}`))})}):e.jsx(w,{children:e.jsx(k,{className:"p-6 text-center",children:e.jsxs("div",{className:"flex flex-col items-center justify-center py-6 space-y-2",children:[e.jsx(W,{className:"h-12 w-12 text-muted-foreground mb-2"}),e.jsx("h3",{className:"font-medium text-lg",children:"Loading provider schedule"}),e.jsx("p",{className:"text-muted-foreground",children:"Please wait while we load the provider's availability details."})]})})});if(!h)return e.jsx(w,{children:e.jsx(k,{className:"p-6 text-center",children:e.jsxs("div",{className:"flex flex-col items-center justify-center py-6 space-y-2",children:[e.jsx(de,{className:"h-12 w-12 text-orange-500 mb-2"}),e.jsx("h3",{className:"font-medium text-lg",children:"Not available"}),e.jsx("p",{className:"text-muted-foreground",children:"The provider doesn't work on this day of the week. Please choose another date."})]})})});if(u.length===0&&!T)return e.jsx(w,{children:e.jsx(k,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col items-center justify-center py-6 text-center space-y-2",children:[e.jsx(W,{className:"h-12 w-12 text-muted-foreground mb-2"}),e.jsx("h3",{className:"font-medium text-lg",children:"No available time slots"}),e.jsx("p",{className:"text-muted-foreground",children:r?`There are no available time slots for ${r.name} on this date. Please try another day.`:"There are no available time slots for this date. Please try another day."})]})})});const M=(s,n,d)=>s.length===0||!L(d)?null:e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"font-medium text-sm text-muted-foreground mb-3",children:n}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:s.map(t=>e.jsx(q,{variant:(a==null?void 0:a.startTime)===t.startTime?"default":"outline",size:"sm",className:ce("justify-start relative",(a==null?void 0:a.startTime)===t.startTime?"border-primary":"",X(t)?"bg-amber-50 dark:bg-amber-950/20":"",typeof t.score=="number"&&t.score>=80?"border-green-500 border-2 bg-green-50 dark:bg-green-900/20":"",typeof t.score=="number"&&t.score>=50?"border-blue-400 border":""),onClick:()=>G(t),disabled:N,children:N&&(a==null?void 0:a.startTime)===t.startTime?e.jsx(O,{className:"h-4 w-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"flex-1 text-center",children:[p(t.startTime),r&&` - ${p(t.endTime||b(t.startTime,r.durationMinutes))}`]}),(a==null?void 0:a.startTime)===t.startTime&&e.jsx(U,{className:"h-4 w-4 absolute right-2"})]})},`${t.startTime}-${t.availabilityId||""}`))})]});return e.jsxs("div",{className:"space-y-2",children:[M(Y,"Morning","morning"),M(ee,"Afternoon","afternoon"),M(se,"Evening","evening")]})}function Fe(){const[,f]=ue(),[c,r]=fe("/client/book/:providerId/:serviceId"),{toast:C}=V(),[a,u]=o.useState({serviceId:c?parseInt((r==null?void 0:r.serviceId)||"0"):0,serviceName:"",servicePrice:0,serviceDuration:0,providerId:c?parseInt((r==null?void 0:r.providerId)||"0"):0,providerName:""}),[l,T]=o.useState(H(new Date,1)),[m,N]=o.useState(),{isLoading:S}=K({queryKey:[`/api/services/${a.serviceId}`],enabled:!!a.serviceId,staleTime:5*60*1e3,retry:2,refetchOnWindowFocus:!1}),i=J.getQueryData([`/api/services/${a.serviceId}`]);o.useEffect(()=>{i&&u(h=>({...h,serviceName:i.name||"",servicePrice:i.price||0,serviceDuration:i.duration||0}))},[i]);const{isLoading:I}=K({queryKey:[`/api/providers/${a.providerId}`],enabled:!!a.providerId,staleTime:5*60*1e3,retry:2,refetchOnWindowFocus:!1}),v=J.getQueryData([`/api/providers/${a.providerId}`]);o.useEffect(()=>{v&&u(h=>({...h,providerName:v.name||""}))},[v]);const y=l?pe(l,"yyyy-MM-dd"):"";o.useEffect(()=>{y&&u(h=>({...h,date:y}))},[y]);const g=h=>{N(h),u(L=>({...L,timeSlot:h}))},D=()=>{if(!l||!m){C({title:"Selecione uma data e horário",description:"Por favor, escolha uma data e um horário disponível para continuar",variant:"destructive"});return}sessionStorage.setItem("bookingState",JSON.stringify(a)),f("/client/book/confirm")};return S||I?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(O,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs("div",{className:"container max-w-4xl py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Agendamento de Serviço"}),e.jsxs("p",{className:"text-muted-foreground",children:["Selecione a data e horário para ",a.serviceName," com ",a.providerName]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(w,{children:[e.jsxs(B,{children:[e.jsxs(F,{className:"flex items-center",children:[e.jsx(he,{className:"mr-2 h-5 w-5"}),"Selecione a data"]}),e.jsx(Z,{children:"Escolha o dia para o seu agendamento"})]}),e.jsx(k,{children:e.jsx(te,{mode:"single",selected:l,onSelect:T,locale:ge,fromDate:H(new Date,1),toDate:H(new Date,60),className:"border rounded-md p-3"})})]}),e.jsxs(w,{children:[e.jsxs(B,{children:[e.jsxs(F,{className:"flex items-center",children:[e.jsx(W,{className:"mr-2 h-5 w-5"}),"Selecione o horário"]}),e.jsx(Z,{children:l?`Horários disponíveis para ${_(l)}`:"Selecione uma data para ver os horários disponíveis"})]}),e.jsx(k,{children:l?e.jsx(je,{providerId:a.providerId,serviceId:a.serviceId,date:y,onTimeSlotSelect:g,selectedTimeSlot:m}):e.jsx("div",{className:"py-6 text-center text-muted-foreground",children:"Selecione uma data no calendário"})})]})]}),e.jsxs(w,{className:"mt-6",children:[e.jsx(B,{children:e.jsx(F,{children:"Detalhes do agendamento"})}),e.jsx(k,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Serviço:"}),e.jsx("span",{className:"font-medium",children:a.serviceName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Prestador:"}),e.jsx("span",{className:"font-medium",children:a.providerName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Data:"}),e.jsx("span",{className:"font-medium",children:l?_(l):"Não selecionada"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Horário:"}),e.jsx("span",{className:"font-medium",children:m!=null&&m.startTime?`${m.startTime} - ${m.endTime}`:"Não selecionado"})]})]})}),e.jsx(le,{className:"flex justify-end",children:e.jsxs(q,{onClick:D,disabled:!l||!m,className:"w-full md:w-auto",children:["Continuar",e.jsx(xe,{className:"ml-2 h-4 w-4"})]})})]})]})}export{Fe as default};
