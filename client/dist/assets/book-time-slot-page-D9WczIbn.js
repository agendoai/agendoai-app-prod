import{r as o,c as V,l as R,D as b,E as re,F as ie,G as ne,j as e,e as O,I as p,C as w,i as k,o as oe,z as de,a as ce,J as le,d as Q,q as J,f as B,g as F,h as Z,K as _,k as me}from"./index-DFO2lo2s.js";import{C as ue}from"./calendar-CiY0AdYf.js";import{B as q}from"./button-6IH7luFD.js";import{S as fe}from"./skeleton-DHzWUt6V.js";import{C as U}from"./check-C4mt73Rm.js";import{C as G}from"./clock-BQ1l0DXv.js";import{C as he}from"./calendar-CXCri533.js";import{C as xe}from"./chevron-right-BpYdX1P5.js";import{a as H}from"./addDays-BQ37Zmqx.js";import{f as pe}from"./format-CGvBu07F.js";import{p as ge}from"./pt-BR-Cxqo7XV3.js";import"./en-US-xSPtgCq_.js";import"./endOfMonth-CH6FLORf.js";import"./isSameDay-BJjwZdUf.js";import"./chevron-left-CKZU-S_c.js";function je({providerId:f,date:c,service:t,onTimeSlotSelect:C,selectedTimeSlot:a}){console.log("TimeSlotSelector RENDERIZADO",{providerId:f,date:c,service:t});const[u,l]=o.useState([]),[T,m]=o.useState(!1),[N,D]=o.useState(!1),[i,$]=o.useState(null),[v,y]=o.useState([]),{toast:g}=V();console.log("TimeSlotSelector - timeSlots:",u),o.useEffect(()=>{t&&a&&C(void 0)},[t]);const S=o.useCallback(async()=>{if(!(!f||!c)){m(!0);try{const s=await R("GET",`/api/providers/${f}/schedule`);if(!s.ok)throw new Error("Failed to load provider schedule");const n=await s.json();$(n.schedule);const d=await R("GET",`/api/bookings?providerId=${f}&date=${c}`);if(!d.ok)throw new Error("Failed to load existing bookings");const r=await d.json();y(r.bookings||[])}catch{g({title:"Error",description:"Could not load provider availability",variant:"destructive"})}finally{m(!1)}}},[f,c,g]);o.useEffect(()=>{S()},[S]);const P=o.useCallback(s=>{if(!s||!s.startTime||!i)return!1;const n=(t==null?void 0:t.durationMinutes)||i.timeSlotInterval;return s.endTime||b(s.startTime,n),s.isAvailable===!0&&re(s,i,n)&&ie(s,i.blockedSlots,c,n)&&ne(s,v,n)},[i,v,t,c]);o.useEffect(()=>{if(!f||!c||!i)return;(async()=>{m(!0);try{const n=`/api/providers/${f}/time-slots?date=${c}&duration=${(t==null?void 0:t.durationMinutes)||30}`,r=await(await R("GET",n)).json();console.log("[API] /api/providers/:id/time-slots - RESPOSTA:",r);const x=Array.isArray(r)?r:r.timeSlots||[],L=new Date().toISOString().split("T")[0],E=new Date,ae=x.filter(j=>{if(c===L){const[I,te]=j.startTime.split(":").map(Number),K=new Date;return K.setHours(I,te,0,0),K>E}return!0}).map(j=>{const I=(t==null?void 0:t.durationMinutes)||i.timeSlotInterval;return{...j,endTime:j.endTime||b(j.startTime,I),formattedSlot:`${p(j.startTime)} - ${p(b(j.startTime,I))}`}}).filter(P);l(ae)}catch{g({title:"Error",description:"Could not load available time slots",variant:"destructive"}),l([])}finally{m(!1)}})()},[f,c,t,i,P,g]);const h=i?i.workingDays.includes(new Date(c).getDay()):!1,M=o.useCallback(s=>{if(!i)return!0;const[n,d]=s==="morning"?["06:00","12:00"]:s==="afternoon"?["12:00","18:00"]:["18:00","23:59"];return!(d<=i.startTime||n>=i.endTime)},[i]),W=async s=>{if(s.isAvailable){D(!0);try{const n=(t==null?void 0:t.durationMinutes)||(i==null?void 0:i.timeSlotInterval)||0,d=s.endTime||b(s.startTime,n);C({...s,endTime:d,formattedSlot:`${p(s.startTime)} - ${p(d)}`})}catch{g({title:"Error",description:"Could not select time slot",variant:"destructive"})}finally{D(!1)}}},X=o.useCallback(s=>{if(!i||!t)return!1;const n=t.durationMinutes+(t.bufferTime||0),d=b(s.startTime,n),r=i.endTime,[x,L]=d.split(":").map(Number),[E,z]=r.split(":").map(Number);return x>E||x===E&&L>z},[i,t]),{morningSlots:Y,afternoonSlots:ee,eveningSlots:se}=o.useMemo(()=>{const s=[],n=[],d=[];return u.forEach(r=>{const x=parseInt(r.startTime.split(":")[0]);x>=6&&x<12?s.push(r):x>=12&&x<18?n.push(r):d.push(r)}),{morningSlots:s,afternoonSlots:n,eveningSlots:d}},[u]);if(T)return e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:Array.from({length:8}).map((s,n)=>e.jsx(fe,{className:"h-10 w-full"},n))})});if(!i)return u.length>0?e.jsx("div",{className:"space-y-2",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:u.map(s=>e.jsx(q,{variant:(a==null?void 0:a.startTime)===s.startTime?"default":"outline",size:"sm",className:"justify-start relative",onClick:()=>W(s),disabled:N,children:N&&(a==null?void 0:a.startTime)===s.startTime?e.jsx(O,{className:"h-4 w-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"flex-1 text-center",children:[p(s.startTime),s.endTime&&` - ${p(s.endTime)}`]}),(a==null?void 0:a.startTime)===s.startTime&&e.jsx(U,{className:"h-4 w-4 absolute right-2"})]})},`${s.startTime}-${s.availabilityId||""}`))})}):e.jsx(w,{children:e.jsx(k,{className:"p-6 text-center",children:e.jsxs("div",{className:"flex flex-col items-center justify-center py-6 space-y-2",children:[e.jsx(G,{className:"h-12 w-12 text-muted-foreground mb-2"}),e.jsx("h3",{className:"font-medium text-lg",children:"Loading provider schedule"}),e.jsx("p",{className:"text-muted-foreground",children:"Please wait while we load the provider's availability details."})]})})});if(!h)return e.jsx(w,{children:e.jsx(k,{className:"p-6 text-center",children:e.jsxs("div",{className:"flex flex-col items-center justify-center py-6 space-y-2",children:[e.jsx(oe,{className:"h-12 w-12 text-orange-500 mb-2"}),e.jsx("h3",{className:"font-medium text-lg",children:"Not available"}),e.jsx("p",{className:"text-muted-foreground",children:"The provider doesn't work on this day of the week. Please choose another date."})]})})});if(u.length===0&&!T)return e.jsx(w,{children:e.jsx(k,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col items-center justify-center py-6 text-center space-y-2",children:[e.jsx(G,{className:"h-12 w-12 text-muted-foreground mb-2"}),e.jsx("h3",{className:"font-medium text-lg",children:"No available time slots"}),e.jsx("p",{className:"text-muted-foreground",children:t?`There are no available time slots for ${t.name} on this date. Please try another day.`:"There are no available time slots for this date. Please try another day."})]})})});const A=(s,n,d)=>s.length===0||!M(d)?null:e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"font-medium text-sm text-muted-foreground mb-3",children:n}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:s.map(r=>e.jsx(q,{variant:(a==null?void 0:a.startTime)===r.startTime?"default":"outline",size:"sm",className:de("justify-start relative",(a==null?void 0:a.startTime)===r.startTime?"border-primary":"",X(r)?"bg-amber-50 dark:bg-amber-950/20":"",typeof r.score=="number"&&r.score>=80?"border-green-500 border-2 bg-green-50 dark:bg-green-900/20":"",typeof r.score=="number"&&r.score>=50?"border-blue-400 border":""),onClick:()=>W(r),disabled:N,children:N&&(a==null?void 0:a.startTime)===r.startTime?e.jsx(O,{className:"h-4 w-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"flex-1 text-center",children:[p(r.startTime),t&&` - ${p(r.endTime||b(r.startTime,t.durationMinutes))}`]}),(a==null?void 0:a.startTime)===r.startTime&&e.jsx(U,{className:"h-4 w-4 absolute right-2"})]})},`${r.startTime}-${r.availabilityId||""}`))})]});return e.jsxs("div",{className:"space-y-2",children:[A(Y,"Morning","morning"),A(ee,"Afternoon","afternoon"),A(se,"Evening","evening")]})}function Ae(){const[,f]=ce(),[c,t]=le("/client/book/:providerId/:serviceId"),{toast:C}=V(),[a,u]=o.useState({serviceId:c?parseInt((t==null?void 0:t.serviceId)||"0"):0,serviceName:"",servicePrice:0,serviceDuration:0,providerId:c?parseInt((t==null?void 0:t.providerId)||"0"):0,providerName:""}),[l,T]=o.useState(H(new Date,1)),[m,N]=o.useState(),{isLoading:D}=Q({queryKey:[`/api/services/${a.serviceId}`],enabled:!!a.serviceId,staleTime:5*60*1e3,retry:2,refetchOnWindowFocus:!1}),i=J.getQueryData([`/api/services/${a.serviceId}`]);o.useEffect(()=>{i&&u(h=>({...h,serviceName:i.name||"",servicePrice:i.price||0,serviceDuration:i.duration||0}))},[i]);const{isLoading:$}=Q({queryKey:[`/api/providers/${a.providerId}`],enabled:!!a.providerId,staleTime:5*60*1e3,retry:2,refetchOnWindowFocus:!1}),v=J.getQueryData([`/api/providers/${a.providerId}`]);o.useEffect(()=>{v&&u(h=>({...h,providerName:v.name||""}))},[v]);const y=l?pe(l,"yyyy-MM-dd"):"";o.useEffect(()=>{y&&u(h=>({...h,date:y}))},[y]);const g=h=>{N(h),u(M=>({...M,timeSlot:h}))},S=()=>{if(!l||!m){C({title:"Selecione uma data e horário",description:"Por favor, escolha uma data e um horário disponível para continuar",variant:"destructive"});return}sessionStorage.setItem("bookingState",JSON.stringify(a)),f("/client/book/confirm")};return D||$?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(O,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs("div",{className:"container max-w-4xl py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Agendamento de Serviço"}),e.jsxs("p",{className:"text-muted-foreground",children:["Selecione a data e horário para ",a.serviceName," com ",a.providerName]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(w,{children:[e.jsxs(B,{children:[e.jsxs(F,{className:"flex items-center",children:[e.jsx(he,{className:"mr-2 h-5 w-5"}),"Selecione a data"]}),e.jsx(Z,{children:"Escolha o dia para o seu agendamento"})]}),e.jsx(k,{children:e.jsx(ue,{mode:"single",selected:l,onSelect:T,locale:ge,fromDate:H(new Date,1),toDate:H(new Date,60),className:"border rounded-md p-3"})})]}),e.jsxs(w,{children:[e.jsxs(B,{children:[e.jsxs(F,{className:"flex items-center",children:[e.jsx(G,{className:"mr-2 h-5 w-5"}),"Selecione o horário"]}),e.jsx(Z,{children:l?`Horários disponíveis para ${_(l)}`:"Selecione uma data para ver os horários disponíveis"})]}),e.jsx(k,{children:l?e.jsx(je,{providerId:a.providerId,serviceId:a.serviceId,date:y,onTimeSlotSelect:g,selectedTimeSlot:m}):e.jsx("div",{className:"py-6 text-center text-muted-foreground",children:"Selecione uma data no calendário"})})]})]}),e.jsxs(w,{className:"mt-6",children:[e.jsx(B,{children:e.jsx(F,{children:"Detalhes do agendamento"})}),e.jsx(k,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Serviço:"}),e.jsx("span",{className:"font-medium",children:a.serviceName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Prestador:"}),e.jsx("span",{className:"font-medium",children:a.providerName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Data:"}),e.jsx("span",{className:"font-medium",children:l?_(l):"Não selecionada"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Horário:"}),e.jsx("span",{className:"font-medium",children:m!=null&&m.startTime?`${m.startTime} - ${m.endTime}`:"Não selecionado"})]})]})}),e.jsx(me,{className:"flex justify-end",children:e.jsxs(q,{onClick:S,disabled:!l||!m,className:"w-full md:w-auto",children:["Continuar",e.jsx(xe,{className:"ml-2 h-4 w-4"})]})})]})]})}export{Ae as default};
