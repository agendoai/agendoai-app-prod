import{j as e}from"./ui-UIpCtT3r.js";import{r as l}from"./vendor-vA4cx1mx.js";import{u as re,L as k,b as xe}from"./router-CxXythJb.js";import{j as fe,u as te,l as he,b as oe,B as y,X as je,H as ge,c as E,C as M,d as T,e as L,g as R,L as O,f as ye,q as ve,i as Ne,E as be,n as V}from"./index-DyNThJGx.js";import{u as we}from"./useMutation-upcUYYIZ.js";import{T as Ce}from"./textarea-CqwWVFXe.js";import{R as Ie,a as X}from"./radio-group-y0TLl7pf.js";import{L as q}from"./label-BRQ1ms59.js";import{S as H}from"./separator-BO2ZN1UN.js";import{S as Se}from"./slider-Br037VI7.js";import{S as Ae}from"./switch-BQ2MZxmv.js";import{a as Pe,S as ke,b as Ee,c as Me,d as Te}from"./sheet-DimnR-Dd.js";import{A as Y,a as Z,b as ee}from"./avatar-SFIqVQOH.js";import{M as Le}from"./menu-B3vjIUbu.js";import{S as Re}from"./search-7vo4URqD.js";import{C as qe}from"./calendar-clock-OAfTW7w_.js";import{M as Be}from"./map-pin-DrpM0WCb.js";import{C as Fe}from"./circle-user-BY0AVJ_H.js";import{A as ze}from"./arrow-left-DD0ygwFe.js";import{U as $e}from"./user-CHl9goRc.js";import{C as De}from"./calendar-CqpYA11m.js";import{C as Ue}from"./clock-Cy7Y6FGJ.js";import{B as se}from"./banknote-BCE19pat.js";import{C as J}from"./credit-card-BAr81XRd.js";import{Q as ae}from"./qr-code-BYH57Q-P.js";import{P as Oe}from"./percent-DW1rUY60.js";import{S as Ve}from"./share-2-CRUUAGC-.js";import{p as He}from"./parse-DkXBBKDI.js";import{f as Je}from"./format-CGvBu07F.js";import{p as Ke}from"./pt-BR-Cxqo7XV3.js";import"./index-BH3L9zMK.js";import"./circle-BxF79SA4.js";import"./index-BdQq_4o_.js";import"./en-US-xSPtgCq_.js";import"./addDays-BQ37Zmqx.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=fe("Tags",[["path",{d:"m15 5 6.3 6.3a2.4 2.4 0 0 1 0 3.4L17 19",key:"1cbfv1"}],["path",{d:"M9.586 5.586A2 2 0 0 0 8.172 5H3a1 1 0 0 0-1 1v5.172a2 2 0 0 0 .586 1.414L8.29 18.29a2.426 2.426 0 0 0 3.42 0l3.58-3.58a2.426 2.426 0 0 0 0-3.42z",key:"135mg7"}],["circle",{cx:"6.5",cy:"9.5",r:".5",fill:"currentColor",key:"5pm5xn"}]]);function Ge(){const{user:t,logoutMutation:P}=te(),{unreadCount:j}=he(),[d]=re(),[g,x]=l.useState(!1),[B,ne]=l.useState(!1),{toast:I}=oe(),S=()=>{if(!t||!t.name)return"U";const a=t.name.split(" ");return a.length===1?a[0][0].toUpperCase():(a[0][0]+a[a.length-1][0]).toUpperCase()},i=a=>d.startsWith(a),u=[{path:"/client/dashboard",label:"InÃ­cio",icon:e.jsx(ge,{size:20})},{path:"/client/search",label:"Buscar",icon:e.jsx(Re,{size:20})},{path:"/client/appointments",label:"Agendamentos",icon:e.jsx(qe,{size:20})},{path:"/client/provider-map",label:"Mapa",icon:e.jsx(Be,{size:20})},{path:"/client/profile",label:"Perfil",icon:e.jsx(Fe,{size:20})}],w=()=>{localStorage.removeItem("authToken"),sessionStorage.removeItem("authToken"),window.authToken&&(window.authToken=void 0),document.cookie="authToken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="authToken=; path=/; domain="+window.location.hostname+"; expires=Thu, 01 Jan 1970 00:00:00 GMT","caches"in window&&caches.keys().then(a=>{a.forEach(F=>{caches.delete(F)})}),I({title:"Logout realizado",description:"VocÃª saiu da sua conta com sucesso."}),setTimeout(()=>{console.log("ðŸ”„ Recarregando pÃ¡gina..."),window.location.reload()},500)};return e.jsx("header",{className:"sticky top-0 z-50 bg-white border-b border-gray-200",children:e.jsxs("div",{className:"container flex items-center justify-between h-14 px-4",children:[e.jsx(k,{href:"/client/dashboard",className:"flex items-center space-x-2",children:e.jsx("img",{src:"/logo.svg",alt:"AgendoAI",className:"h-8 w-auto"})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(Pe,{open:g,onOpenChange:x,children:[e.jsx(ke,{asChild:!0,children:e.jsxs(y,{variant:"ghost",size:"icon",className:"md:hidden",children:[e.jsx(Le,{size:24}),e.jsx("span",{className:"sr-only",children:"Menu"})]})}),e.jsxs(Ee,{side:"left",className:"p-0",children:[e.jsx(Me,{className:"p-4 border-b",children:e.jsxs(Te,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Menu"}),e.jsx(y,{variant:"ghost",size:"icon",onClick:()=>x(!1),children:e.jsx(je,{size:18})})]})}),t&&e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs(Y,{children:[e.jsx(Z,{src:t.profileImage}),e.jsx(ee,{children:S()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.name||t.email}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Cliente"})]})]})}),e.jsx("nav",{className:"p-2",children:e.jsx("ul",{className:"space-y-1",children:u.map(a=>e.jsx("li",{children:e.jsx(k,{href:a.path,children:e.jsxs("a",{className:`flex items-center space-x-3 px-3 py-2 rounded-md text-sm ${i(a.path)?"bg-primary text-primary-foreground":"hover:bg-primary/10"}`,onClick:()=>x(!1),children:[a.icon,e.jsx("span",{children:a.label})]})})},a.path))})}),e.jsx("div",{className:"p-4 border-t mt-auto",children:e.jsx(y,{variant:"outline",className:"w-full",onClick:w,children:"Sair"})})]})]}),e.jsx("nav",{className:"hidden md:flex items-center space-x-1",children:u.map(a=>e.jsx(k,{href:a.path,children:e.jsxs("a",{className:`flex items-center space-x-1 px-3 py-2 rounded-md text-sm ${i(a.path)?"bg-primary text-primary-foreground":"hover:bg-primary/10"}`,children:[a.icon,e.jsx("span",{children:a.label})]})},a.path))}),e.jsx(k,{href:"/client/profile",children:e.jsx("a",{className:"flex items-center space-x-2",children:e.jsxs(Y,{className:"h-8 w-8",children:[e.jsx(Z,{src:t==null?void 0:t.profileImage,alt:(t==null?void 0:t.name)||"UsuÃ¡rio"}),e.jsx(ee,{children:S()})]})})})]})]})})}function Qe(t,P){try{const j=encodeURIComponent(t);let d="https://wa.me/";d+=`?text=${j}`,window.open(d,"_blank")}catch(j){console.error("Erro ao compartilhar no WhatsApp:",j)}}function Ms(){const[,t]=re(),{providerId:P,serviceId:j,date:d,startTime:g,endTime:x,availabilityId:B}=xe(),I=l.useMemo(()=>new URLSearchParams(window.location.search),[]).get("additionalServices"),S=l.useMemo(()=>I?I.split(",").map(s=>parseInt(s)).filter(s=>!isNaN(s)):[],[I]);l.useMemo(()=>[parseInt(j),...S],[j,S]);const i=parseInt(P),u=parseInt(j),w=B?parseInt(B):void 0,[a,F]=l.useState(""),[v,z]=l.useState("money"),[A,K]=l.useState("offline"),[C,ie]=l.useState(0),[$,ce]=l.useState(!1),{toast:f}=oe(),{user:h}=te(),{data:N,isLoading:_}=E({queryKey:["/api/payment-methods/available"],queryFn:()=>fetch("/api/payment-methods/available").then(s=>{if(!s.ok)throw new Error("Erro ao buscar mÃ©todos de pagamento");return s.json()})}),{data:m,isLoading:le}=E({queryKey:["/api/providers",i,"payment-methods"],queryFn:()=>V(`/providers/${i}/payment-methods`).then(s=>{if(!s.ok)throw new Error("Erro ao buscar mÃ©todos de pagamento do prestador");return s.json()}),enabled:!!i}),G=(()=>{try{const s=He(d,"yyyy-MM-dd",new Date);return Je(s,"EEEE, dd 'de' MMMM 'de' yyyy",{locale:Ke})}catch(s){return console.error("Erro ao formatar data:",s),d}})(),{data:c,isLoading:de}=E({queryKey:["/api/providers",i],queryFn:()=>(console.log(`Buscando dados do prestador para confirmaÃ§Ã£o: ${i}`),V(`/providers/${i}`).then(s=>{if(!s.ok)throw new Error(`Erro ao buscar prestador: ${s.status}`);return s.json()})),enabled:!!i}),{data:o,isLoading:me}=E({queryKey:["/api/services",u],queryFn:()=>(console.log(`Buscando serviÃ§o por ID: ${u}`),V(`/services/${u}`).then(s=>{if(!s.ok)throw new Error(`Erro ao buscar serviÃ§o: ${s.status}`);return s.json()})),enabled:!!u}),D=we({mutationFn:async s=>{const r=await Ne("POST","/api/appointments",s);if(!r.ok){const b=await r.json();throw new Error(b.error||"Erro ao criar agendamento")}return r.json()},onSuccess:s=>{console.log("Agendamento criado com sucesso:",s),ve.invalidateQueries({queryKey:["/api/appointments"]}),f({title:"Agendamento confirmado!",description:"Seu agendamento foi registrado com sucesso."}),console.log("Resposta completa da API ao criar agendamento:",JSON.stringify(s));let r=null;if(s&&s.appointment&&s.appointment.id)r=s.appointment.id;else if(s&&s.id)r=s.id;else if(s&&typeof s=="object"){const b=n=>{if(!n||typeof n!="object")return null;if("id"in n&&typeof n.id=="number")return n.id;for(const Q in n)if(typeof n[Q]=="object"){const W=b(n[Q]);if(W)return W}return null};r=b(s)}r?(console.log("Redirecionando para pÃ¡gina de sucesso com appointmentId:",r),t(`/client/booking-success?appointmentId=${r}`)):(console.error("Erro: ID do agendamento nÃ£o encontrado na resposta",s),f({title:"Erro de redirecionamento",description:"NÃ£o foi possÃ­vel acessar os detalhes do agendamento.",variant:"destructive"}),t("/client/appointments"))},onError:s=>{console.error("Erro ao criar agendamento:",s),f({title:"Erro ao agendar",description:s.message,variant:"destructive"})}});l.useEffect(()=>{if(h)console.log("UsuÃ¡rio autenticado, ID:",h.id,"Tipo:",h.userType||"nÃ£o especificado");else{const s={providerId:i,serviceId:u,date:d,startTime:g,endTime:x,availabilityId:w};sessionStorage.setItem("pendingBooking",JSON.stringify(s)),f({title:"AutenticaÃ§Ã£o necessÃ¡ria",description:"Ã‰ necessÃ¡rio estar logado para confirmar o agendamento. Redirecionando para o login...",variant:"default"}),setTimeout(()=>{t("/auth?redirect=booking")},1500)}},[h,i,u,d,g,x,w,t,f]);const pe=async()=>{if(!h){f({title:"UsuÃ¡rio nÃ£o autenticado",description:"VocÃª precisa estar logado para agendar.",variant:"destructive"}),sessionStorage.setItem("pendingBooking",JSON.stringify({providerId:i,serviceId:u,date:d,startTime:g,endTime:x,availabilityId:w})),t("/auth?redirect=booking");return}if(!c||!o){f({title:"Erro ao confirmar",description:"Dados incompletos para o agendamento.",variant:"destructive"});return}const s=N==null?void 0:N.find(n=>n.id===v);if((s==null?void 0:s.processor)==="asaas"&&(s==null?void 0:s.type)==="online")try{f({title:"Processando pagamento...",description:"Aguarde enquanto processamos seu pagamento."});const n=await be({customerId:h.id.toString(),providerId:i,serviceValue:o.price/100,billingType:v.includes("pix")?"PIX":"CREDIT_CARD",description:`Agendamento - ${o.name} com ${c.name||c.email}`,dueDate:d});if(n.success)f({title:"Pagamento processado!",description:"Pagamento realizado com sucesso. Criando agendamento..."});else throw new Error(n.message||"Erro ao processar pagamento")}catch(n){console.error("Erro no pagamento Asaas:",n),f({title:"Erro no pagamento",description:n.message||"NÃ£o foi possÃ­vel processar o pagamento. Tente novamente.",variant:"destructive"});return}const b={clientId:h.id,providerId:i,serviceId:u,date:d,startTime:g,endTime:x,notes:a,paymentMethod:v,availabilityId:w,discount:$?C:0};console.log("Dados do agendamento:",b),D.mutate(b)},ue=()=>{if(!c||!o)return;const s=`
      Agendei um serviÃ§o no AgendoAI!
      
      ðŸ“ ServiÃ§o: ${o.name}
      ðŸ‘¤ Prestador: ${c.name||c.email}
      ðŸ“… Data: ${G}
      ðŸ•’ HorÃ¡rio: ${g} - ${x}
      
      Baixe o AgendoAI e agende tambÃ©m!
      https://agendoai.com
    `;Qe(s)},p=l.useMemo(()=>{if(!N||!m)return console.log("MÃ©todos de pagamento nÃ£o disponÃ­veis ainda"),[];console.log("Filtrando mÃ©todos de pagamento:",{availablePaymentMethods:N,providerPaymentMethods:m});const s=N.filter(r=>r.type==="offline"?!(r.id==="money"&&!m.acceptsCash||r.id==="card_local"&&!m.acceptsDebitCard&&!m.acceptsCreditCard||r.id==="pix_local"&&!m.acceptsPix||r.id==="transfer"&&!m.acceptsTransfer):r.type==="online"?r.processor==="stripe"&&!m.preferStripe?(console.log("MÃ©todo stripe rejeitado porque prestador nÃ£o prefere Stripe"),!1):r.processor==="asaas"&&!m.preferAsaas?(console.log("MÃ©todo asaas rejeitado porque prestador nÃ£o prefere Asaas"),!1):r.id.includes("card")&&!m.acceptsCreditCard?(console.log("MÃ©todo cartÃ£o rejeitado porque prestador nÃ£o aceita cartÃ£o de crÃ©dito"),!1):r.id.includes("pix")&&!m.acceptsPix?(console.log("MÃ©todo pix rejeitado porque prestador nÃ£o aceita PIX"),!1):!0:!0);return console.log("MÃ©todos filtrados:",s),s},[N,m]);l.useEffect(()=>{v?(p==null?void 0:p.length)>0&&!p.some(s=>s.id===v)&&z(p[0].id):z("money")},[p,v]);const U=de||me||D.isPending||_||le;return e.jsxs("div",{className:"min-h-screen bg-white",children:[e.jsx(Ge,{}),e.jsxs("main",{className:"container px-4 py-8",children:[e.jsxs(y,{variant:"ghost",size:"sm",className:"mb-4",onClick:()=>window.history.back(),children:[e.jsx(ze,{className:"h-4 w-4 mr-2"}),"Voltar"]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Confirmar Agendamento"}),e.jsx("p",{className:"text-muted-foreground",children:"Verifique os detalhes e confirme seu agendamento"})]}),e.jsxs(M,{className:"mb-6",children:[e.jsx(T,{children:e.jsx(L,{children:"Detalhes do Agendamento"})}),e.jsx(R,{className:"space-y-4",children:U?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(O,{className:"h-6 w-6 animate-spin text-primary"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx($e,{className:"h-5 w-5 text-muted-foreground mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:(c==null?void 0:c.name)||(c==null?void 0:c.email)||"Prestador"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:(o==null?void 0:o.name)||"ServiÃ§o"})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(De,{className:"h-5 w-5 text-muted-foreground"}),e.jsx("p",{children:G})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ue,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("p",{children:[g," - ",x]})]}),e.jsx(H,{}),e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("p",{children:"Total"}),e.jsx("p",{children:o?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o.price/100):"Carregando..."})]})]})})]}),e.jsxs(M,{className:"mb-6",children:[e.jsx(T,{children:e.jsx(L,{children:"Forma de Pagamento"})}),e.jsx(R,{children:_?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(O,{className:"h-6 w-6 animate-spin text-primary"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between mb-4",children:[e.jsxs(y,{variant:A==="offline"?"default":"outline",size:"sm",className:"flex-1 mr-2",onClick:()=>K("offline"),disabled:!p.some(s=>s.type==="offline"),children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"No local"]}),e.jsxs(y,{variant:A==="online"?"default":"outline",size:"sm",className:"flex-1 ml-2",onClick:()=>K("online"),disabled:!p.some(s=>s.type==="online"),children:[e.jsx(J,{className:"h-4 w-4 mr-2"}),"Online"]})]}),e.jsx(H,{className:"my-4"}),e.jsxs(Ie,{value:v,onValueChange:z,className:"space-y-3",children:[A==="offline"?p.filter(s=>s.type==="offline").map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(X,{value:s.id,id:s.id}),e.jsxs(q,{htmlFor:s.id,className:"flex items-center",children:[s.id==="money"?e.jsx(se,{className:"h-4 w-4 mr-2 text-muted-foreground"}):s.id==="pix_local"?e.jsx(ae,{className:"h-4 w-4 mr-2 text-muted-foreground"}):e.jsx(J,{className:"h-4 w-4 mr-2 text-muted-foreground"}),s.name]})]},s.id)):p.filter(s=>s.type==="online").map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(X,{value:s.id,id:s.id}),e.jsxs(q,{htmlFor:s.id,className:"flex items-center",children:[s.id.includes("pix")?e.jsx(ae,{className:"h-4 w-4 mr-2 text-muted-foreground"}):e.jsx(J,{className:"h-4 w-4 mr-2 text-muted-foreground"}),s.name,s.processor&&e.jsx("span",{className:"ml-2 text-xs bg-muted text-muted-foreground px-2 py-0.5 rounded-full",children:s.processor==="stripe"?"Stripe":"Asaas"})]})]},s.id)),A==="offline"&&!p.some(s=>s.type==="offline")&&e.jsx("div",{className:"text-center p-4 border border-dashed rounded-md",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Este prestador nÃ£o aceita pagamentos no local."})}),A==="online"&&!p.some(s=>s.type==="online")&&e.jsx("div",{className:"text-center p-4 border border-dashed rounded-md",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Pagamentos online nÃ£o estÃ£o disponÃ­veis para este prestador."})})]})]})})]}),h&&h.userType==="provider"&&e.jsxs(M,{className:"mb-6",children:[e.jsxs(T,{children:[e.jsxs(L,{className:"flex items-center",children:[e.jsx(Oe,{className:"h-5 w-5 mr-2 text-primary"}),"Aplicar Desconto"]}),e.jsx(ye,{children:"Conceda um desconto especial para este cliente"})]}),e.jsx(R,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(q,{htmlFor:"apply-discount",className:"flex items-center cursor-pointer",children:[e.jsx(_e,{className:"h-4 w-4 mr-2 text-muted-foreground"}),"Ativar desconto"]}),e.jsx(Ae,{id:"apply-discount",checked:$,onCheckedChange:ce})]}),$&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(q,{htmlFor:"discount-slider",children:"Percentual de desconto"}),e.jsxs("span",{className:"font-medium text-primary",children:[C,"%"]})]}),e.jsx(Se,{id:"discount-slider",value:[C],min:0,max:30,step:1,onValueChange:([s])=>ie(s),className:"py-4"}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[e.jsx("span",{children:"0%"}),e.jsx("span",{children:"15%"}),e.jsx("span",{children:"30%"})]})]}),(o==null?void 0:o.price)&&e.jsxs("div",{className:"bg-muted/50 p-4 rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"PreÃ§o original:"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o.price/100)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Desconto (",C,"%):"]}),e.jsxs("span",{className:"text-green-600",children:["- ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o.price*C/100/100)]})]}),e.jsx(H,{className:"my-2"}),e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("span",{children:"PreÃ§o final:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format((o.price-o.price*C/100)/100)})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"O desconto Ã© aplicado apenas sobre o valor do serviÃ§o, a taxa da plataforma permanece a mesma."})]})]})]})})]}),e.jsxs(M,{className:"mb-6",children:[e.jsx(T,{children:e.jsx(L,{children:"ObservaÃ§Ãµes"})}),e.jsx(R,{children:e.jsx(Ce,{placeholder:"Adicione informaÃ§Ãµes importantes para o prestador (opcional)",value:a,onChange:s=>F(s.target.value),className:"resize-none",rows:3})})]}),e.jsxs("div",{className:"flex flex-col space-y-3",children:[e.jsxs(y,{onClick:pe,disabled:U,className:"w-full",size:"lg",children:[D.isPending&&e.jsx(O,{className:"mr-2 h-4 w-4 animate-spin"}),"Confirmar Agendamento"]}),e.jsxs(y,{variant:"outline",className:"w-full",onClick:ue,disabled:U||!c||!o,children:[e.jsx(Ve,{className:"mr-2 h-4 w-4"}),"Compartilhar no WhatsApp"]})]})]})]})}export{Ms as default};
