import{j as e}from"./ui-UIpCtT3r.js";import{r as l}from"./vendor-vA4cx1mx.js";import{u as re,L as P,b as xe}from"./router-CxXythJb.js";import{j as fe,u as te,l as he,b as oe,B as g,X as je,H as ge,c as k,C as E,d as M,e as T,g as L,L as U,f as ye,q as ve,i as Ne,F as be,n as O}from"./index-DMVSlINz.js";import{u as we}from"./useMutation-mYWno7MC.js";import{T as Ce}from"./textarea-C4WahNzO.js";import{R as Ie,a as X}from"./radio-group-BopDKadC.js";import{L as R}from"./label-DJxjY-7j.js";import{S as V}from"./separator-D_RfrPgK.js";import{S as Se}from"./slider-Rin09-ek.js";import{S as Ae}from"./switch-Cd7tOnM5.js";import{a as Pe,S as ke,b as Ee,c as Me,d as Te}from"./sheet-46XB4-U3.js";import{A as Y,a as Z,b as ee}from"./avatar-DJ_tL6P_.js";import{M as Le}from"./menu-DQAb75no.js";import{S as Re}from"./search-0bFur5DB.js";import{C as qe}from"./calendar-clock-DsLu4KZh.js";import{M as Be}from"./map-pin-BJouWYuW.js";import{C as Fe}from"./circle-user-B0kf3BOu.js";import{s as ze}from"./whatsapp-CXCPK3xh.js";import{A as De}from"./arrow-left-3dZ_zEs-.js";import{U as $e}from"./user-DxXpbN3a.js";import{C as Ue}from"./calendar-CYlMr0qt.js";import{C as Oe}from"./clock-DluLCsci.js";import{B as se}from"./banknote-B7RGdfb5.js";import{C as H}from"./credit-card-DTBtIUOk.js";import{Q as ae}from"./qr-code-BogfNbKV.js";import{P as Ve}from"./percent-D7H-0Aok.js";import{S as He}from"./share-2-CQaeBUod.js";import{p as Je}from"./parse-DkXBBKDI.js";import{f as Ke}from"./format-CGvBu07F.js";import{p as Ge}from"./pt-BR-Cxqo7XV3.js";import"./index-BH3L9zMK.js";import"./circle-CRjqYs4g.js";import"./index-BdQq_4o_.js";import"./en-US-xSPtgCq_.js";import"./addDays-BQ37Zmqx.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=fe("Tags",[["path",{d:"m15 5 6.3 6.3a2.4 2.4 0 0 1 0 3.4L17 19",key:"1cbfv1"}],["path",{d:"M9.586 5.586A2 2 0 0 0 8.172 5H3a1 1 0 0 0-1 1v5.172a2 2 0 0 0 .586 1.414L8.29 18.29a2.426 2.426 0 0 0 3.42 0l3.58-3.58a2.426 2.426 0 0 0 0-3.42z",key:"135mg7"}],["circle",{cx:"6.5",cy:"9.5",r:".5",fill:"currentColor",key:"5pm5xn"}]]);function _e(){const{user:t,logoutMutation:J}=te(),{unreadCount:A}=he(),[f]=re(),[j,u]=l.useState(!1),[q,ne]=l.useState(!1),{toast:C}=oe(),I=()=>{if(!t||!t.name)return"U";const a=t.name.split(" ");return a.length===1?a[0][0].toUpperCase():(a[0][0]+a[a.length-1][0]).toUpperCase()},i=a=>f.startsWith(a),p=[{path:"/client/dashboard",label:"InÃ­cio",icon:e.jsx(ge,{size:20})},{path:"/client/search",label:"Buscar",icon:e.jsx(Re,{size:20})},{path:"/client/appointments",label:"Agendamentos",icon:e.jsx(qe,{size:20})},{path:"/client/provider-map",label:"Mapa",icon:e.jsx(Be,{size:20})},{path:"/client/profile",label:"Perfil",icon:e.jsx(Fe,{size:20})}],b=()=>{localStorage.removeItem("authToken"),sessionStorage.removeItem("authToken"),window.authToken&&(window.authToken=void 0),document.cookie="authToken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="authToken=; path=/; domain="+window.location.hostname+"; expires=Thu, 01 Jan 1970 00:00:00 GMT","caches"in window&&caches.keys().then(a=>{a.forEach(B=>{caches.delete(B)})}),C({title:"Logout realizado",description:"VocÃª saiu da sua conta com sucesso."}),setTimeout(()=>{console.log("ðŸ”„ Recarregando pÃ¡gina..."),window.location.reload()},500)};return e.jsx("header",{className:"sticky top-0 z-50 bg-white border-b border-gray-200",children:e.jsxs("div",{className:"container flex items-center justify-between h-14 px-4",children:[e.jsx(P,{href:"/client/dashboard",className:"flex items-center space-x-2",children:e.jsx("img",{src:"/logo.svg",alt:"AgendoAI",className:"h-8 w-auto"})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(Pe,{open:j,onOpenChange:u,children:[e.jsx(ke,{asChild:!0,children:e.jsxs(g,{variant:"ghost",size:"icon",className:"md:hidden",children:[e.jsx(Le,{size:24}),e.jsx("span",{className:"sr-only",children:"Menu"})]})}),e.jsxs(Ee,{side:"left",className:"p-0",children:[e.jsx(Me,{className:"p-4 border-b",children:e.jsxs(Te,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Menu"}),e.jsx(g,{variant:"ghost",size:"icon",onClick:()=>u(!1),children:e.jsx(je,{size:18})})]})}),t&&e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs(Y,{children:[e.jsx(Z,{src:t.profileImage}),e.jsx(ee,{children:I()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.name||t.email}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Cliente"})]})]})}),e.jsx("nav",{className:"p-2",children:e.jsx("ul",{className:"space-y-1",children:p.map(a=>e.jsx("li",{children:e.jsx(P,{href:a.path,children:e.jsxs("a",{className:`flex items-center space-x-3 px-3 py-2 rounded-md text-sm ${i(a.path)?"bg-primary text-primary-foreground":"hover:bg-primary/10"}`,onClick:()=>u(!1),children:[a.icon,e.jsx("span",{children:a.label})]})})},a.path))})}),e.jsx("div",{className:"p-4 border-t mt-auto",children:e.jsx(g,{variant:"outline",className:"w-full",onClick:b,children:"Sair"})})]})]}),e.jsx("nav",{className:"hidden md:flex items-center space-x-1",children:p.map(a=>e.jsx(P,{href:a.path,children:e.jsxs("a",{className:`flex items-center space-x-1 px-3 py-2 rounded-md text-sm ${i(a.path)?"bg-primary text-primary-foreground":"hover:bg-primary/10"}`,children:[a.icon,e.jsx("span",{children:a.label})]})},a.path))}),e.jsx(P,{href:"/client/profile",children:e.jsx("a",{className:"flex items-center space-x-2",children:e.jsxs(Y,{className:"h-8 w-8",children:[e.jsx(Z,{src:t==null?void 0:t.profileImage,alt:(t==null?void 0:t.name)||"UsuÃ¡rio"}),e.jsx(ee,{children:I()})]})})})]})]})})}function Ts(){const[,t]=re(),{providerId:J,serviceId:A,date:f,startTime:j,endTime:u,availabilityId:q}=xe(),C=l.useMemo(()=>new URLSearchParams(window.location.search),[]).get("additionalServices"),I=l.useMemo(()=>C?C.split(",").map(s=>parseInt(s)).filter(s=>!isNaN(s)):[],[C]);l.useMemo(()=>[parseInt(A),...I],[A,I]);const i=parseInt(J),p=parseInt(A),b=q?parseInt(q):void 0,[a,B]=l.useState(""),[y,F]=l.useState("money"),[S,K]=l.useState("offline"),[w,ie]=l.useState(0),[z,ce]=l.useState(!1),{toast:x}=oe(),{user:h}=te(),{data:v,isLoading:G}=k({queryKey:["/api/payment-methods/available"],queryFn:()=>fetch("/api/payment-methods/available").then(s=>{if(!s.ok)throw new Error("Erro ao buscar mÃ©todos de pagamento");return s.json()})}),{data:d,isLoading:le}=k({queryKey:["/api/providers",i,"payment-methods"],queryFn:()=>O(`/providers/${i}/payment-methods`).then(s=>{if(!s.ok)throw new Error("Erro ao buscar mÃ©todos de pagamento do prestador");return s.json()}),enabled:!!i}),Q=(()=>{try{const s=Je(f,"yyyy-MM-dd",new Date);return Ke(s,"EEEE, dd 'de' MMMM 'de' yyyy",{locale:Ge})}catch(s){return console.error("Erro ao formatar data:",s),f}})(),{data:c,isLoading:de}=k({queryKey:["/api/providers",i],queryFn:()=>(console.log(`Buscando dados do prestador para confirmaÃ§Ã£o: ${i}`),O(`/providers/${i}`).then(s=>{if(!s.ok)throw new Error(`Erro ao buscar prestador: ${s.status}`);return s.json()})),enabled:!!i}),{data:o,isLoading:me}=k({queryKey:["/api/services",p],queryFn:()=>(console.log(`Buscando serviÃ§o por ID: ${p}`),O(`/services/${p}`).then(s=>{if(!s.ok)throw new Error(`Erro ao buscar serviÃ§o: ${s.status}`);return s.json()})),enabled:!!p}),D=we({mutationFn:async s=>{const r=await Ne("POST","/api/appointments",s);if(!r.ok){const N=await r.json();throw new Error(N.error||"Erro ao criar agendamento")}return r.json()},onSuccess:s=>{console.log("Agendamento criado com sucesso:",s),ve.invalidateQueries({queryKey:["/api/appointments"]}),x({title:"Agendamento confirmado!",description:"Seu agendamento foi registrado com sucesso."}),console.log("Resposta completa da API ao criar agendamento:",JSON.stringify(s));let r=null;if(s&&s.appointment&&s.appointment.id)r=s.appointment.id;else if(s&&s.id)r=s.id;else if(s&&typeof s=="object"){const N=n=>{if(!n||typeof n!="object")return null;if("id"in n&&typeof n.id=="number")return n.id;for(const _ in n)if(typeof n[_]=="object"){const W=N(n[_]);if(W)return W}return null};r=N(s)}r?(console.log("Redirecionando para pÃ¡gina de sucesso com appointmentId:",r),t(`/client/booking-success?appointmentId=${r}`)):(console.error("Erro: ID do agendamento nÃ£o encontrado na resposta",s),x({title:"Erro de redirecionamento",description:"NÃ£o foi possÃ­vel acessar os detalhes do agendamento.",variant:"destructive"}),t("/client/appointments"))},onError:s=>{console.error("Erro ao criar agendamento:",s),x({title:"Erro ao agendar",description:s.message,variant:"destructive"})}});l.useEffect(()=>{if(h)console.log("UsuÃ¡rio autenticado, ID:",h.id,"Tipo:",h.userType||"nÃ£o especificado");else{const s={providerId:i,serviceId:p,date:f,startTime:j,endTime:u,availabilityId:b};sessionStorage.setItem("pendingBooking",JSON.stringify(s)),x({title:"AutenticaÃ§Ã£o necessÃ¡ria",description:"Ã‰ necessÃ¡rio estar logado para confirmar o agendamento. Redirecionando para o login...",variant:"default"}),setTimeout(()=>{t("/auth?redirect=booking")},1500)}},[h,i,p,f,j,u,b,t,x]);const pe=async()=>{if(!h){x({title:"UsuÃ¡rio nÃ£o autenticado",description:"VocÃª precisa estar logado para agendar.",variant:"destructive"}),sessionStorage.setItem("pendingBooking",JSON.stringify({providerId:i,serviceId:p,date:f,startTime:j,endTime:u,availabilityId:b})),t("/auth?redirect=booking");return}if(!c||!o){x({title:"Erro ao confirmar",description:"Dados incompletos para o agendamento.",variant:"destructive"});return}const s=v==null?void 0:v.find(n=>n.id===y);if((s==null?void 0:s.processor)==="asaas"&&(s==null?void 0:s.type)==="online")try{x({title:"Processando pagamento...",description:"Aguarde enquanto processamos seu pagamento."});const n=await be({customerId:h.id.toString(),providerId:i,serviceValue:o.price/100,billingType:y.includes("pix")?"PIX":"CREDIT_CARD",description:`Agendamento - ${o.name} com ${c.name||c.email}`,dueDate:f});if(n.success)x({title:"Pagamento processado!",description:"Pagamento realizado com sucesso. Criando agendamento..."});else throw new Error(n.message||"Erro ao processar pagamento")}catch(n){console.error("Erro no pagamento Asaas:",n),x({title:"Erro no pagamento",description:n.message||"NÃ£o foi possÃ­vel processar o pagamento. Tente novamente.",variant:"destructive"});return}const N={clientId:h.id,providerId:i,serviceId:p,date:f,startTime:j,endTime:u,notes:a,paymentMethod:y,availabilityId:b,discount:z?w:0};console.log("Dados do agendamento:",N),D.mutate(N)},ue=()=>{if(!c||!o)return;const s=`
      Agendei um serviÃ§o no AgendoAI!
      
      ðŸ“ ServiÃ§o: ${o.name}
      ðŸ‘¤ Prestador: ${c.name||c.email}
      ðŸ“… Data: ${Q}
      ðŸ•’ HorÃ¡rio: ${j} - ${u}
      
      Baixe o AgendoAI e agende tambÃ©m!
      https://agendoai.com
    `;ze(s)},m=l.useMemo(()=>{if(!v||!d)return console.log("MÃ©todos de pagamento nÃ£o disponÃ­veis ainda"),[];console.log("Filtrando mÃ©todos de pagamento:",{availablePaymentMethods:v,providerPaymentMethods:d});const s=v.filter(r=>r.type==="offline"?!(r.id==="money"&&!d.acceptsCash||r.id==="card_local"&&!d.acceptsDebitCard&&!d.acceptsCreditCard||r.id==="pix_local"&&!d.acceptsPix||r.id==="transfer"&&!d.acceptsTransfer):r.type==="online"?r.processor==="stripe"&&!d.preferStripe?(console.log("MÃ©todo stripe rejeitado porque prestador nÃ£o prefere Stripe"),!1):r.processor==="asaas"&&!d.preferAsaas?(console.log("MÃ©todo asaas rejeitado porque prestador nÃ£o prefere Asaas"),!1):r.id.includes("card")&&!d.acceptsCreditCard?(console.log("MÃ©todo cartÃ£o rejeitado porque prestador nÃ£o aceita cartÃ£o de crÃ©dito"),!1):r.id.includes("pix")&&!d.acceptsPix?(console.log("MÃ©todo pix rejeitado porque prestador nÃ£o aceita PIX"),!1):!0:!0);return console.log("MÃ©todos filtrados:",s),s},[v,d]);l.useEffect(()=>{y?(m==null?void 0:m.length)>0&&!m.some(s=>s.id===y)&&F(m[0].id):F("money")},[m,y]);const $=de||me||D.isPending||G||le;return e.jsxs("div",{className:"min-h-screen bg-white",children:[e.jsx(_e,{}),e.jsxs("main",{className:"container px-4 py-8",children:[e.jsxs(g,{variant:"ghost",size:"sm",className:"mb-4",onClick:()=>window.history.back(),children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),"Voltar"]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Confirmar Agendamento"}),e.jsx("p",{className:"text-muted-foreground",children:"Verifique os detalhes e confirme seu agendamento"})]}),e.jsxs(E,{className:"mb-6",children:[e.jsx(M,{children:e.jsx(T,{children:"Detalhes do Agendamento"})}),e.jsx(L,{className:"space-y-4",children:$?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(U,{className:"h-6 w-6 animate-spin text-primary"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx($e,{className:"h-5 w-5 text-muted-foreground mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:(c==null?void 0:c.name)||(c==null?void 0:c.email)||"Prestador"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:(o==null?void 0:o.name)||"ServiÃ§o"})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ue,{className:"h-5 w-5 text-muted-foreground"}),e.jsx("p",{children:Q})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Oe,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("p",{children:[j," - ",u]})]}),e.jsx(V,{}),e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("p",{children:"Total"}),e.jsx("p",{children:o?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o.price/100):"Carregando..."})]})]})})]}),e.jsxs(E,{className:"mb-6",children:[e.jsx(M,{children:e.jsx(T,{children:"Forma de Pagamento"})}),e.jsx(L,{children:G?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(U,{className:"h-6 w-6 animate-spin text-primary"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between mb-4",children:[e.jsxs(g,{variant:S==="offline"?"default":"outline",size:"sm",className:"flex-1 mr-2",onClick:()=>K("offline"),disabled:!m.some(s=>s.type==="offline"),children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"No local"]}),e.jsxs(g,{variant:S==="online"?"default":"outline",size:"sm",className:"flex-1 ml-2",onClick:()=>K("online"),disabled:!m.some(s=>s.type==="online"),children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"Online"]})]}),e.jsx(V,{className:"my-4"}),e.jsxs(Ie,{value:y,onValueChange:F,className:"space-y-3",children:[S==="offline"?m.filter(s=>s.type==="offline").map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(X,{value:s.id,id:s.id}),e.jsxs(R,{htmlFor:s.id,className:"flex items-center",children:[s.id==="money"?e.jsx(se,{className:"h-4 w-4 mr-2 text-muted-foreground"}):s.id==="pix_local"?e.jsx(ae,{className:"h-4 w-4 mr-2 text-muted-foreground"}):e.jsx(H,{className:"h-4 w-4 mr-2 text-muted-foreground"}),s.name]})]},s.id)):m.filter(s=>s.type==="online").map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(X,{value:s.id,id:s.id}),e.jsxs(R,{htmlFor:s.id,className:"flex items-center",children:[s.id.includes("pix")?e.jsx(ae,{className:"h-4 w-4 mr-2 text-muted-foreground"}):e.jsx(H,{className:"h-4 w-4 mr-2 text-muted-foreground"}),s.name,s.processor&&e.jsx("span",{className:"ml-2 text-xs bg-muted text-muted-foreground px-2 py-0.5 rounded-full",children:s.processor==="stripe"?"Stripe":"Asaas"})]})]},s.id)),S==="offline"&&!m.some(s=>s.type==="offline")&&e.jsx("div",{className:"text-center p-4 border border-dashed rounded-md",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Este prestador nÃ£o aceita pagamentos no local."})}),S==="online"&&!m.some(s=>s.type==="online")&&e.jsx("div",{className:"text-center p-4 border border-dashed rounded-md",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Pagamentos online nÃ£o estÃ£o disponÃ­veis para este prestador."})})]})]})})]}),h&&h.userType==="provider"&&e.jsxs(E,{className:"mb-6",children:[e.jsxs(M,{children:[e.jsxs(T,{className:"flex items-center",children:[e.jsx(Ve,{className:"h-5 w-5 mr-2 text-primary"}),"Aplicar Desconto"]}),e.jsx(ye,{children:"Conceda um desconto especial para este cliente"})]}),e.jsx(L,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(R,{htmlFor:"apply-discount",className:"flex items-center cursor-pointer",children:[e.jsx(Qe,{className:"h-4 w-4 mr-2 text-muted-foreground"}),"Ativar desconto"]}),e.jsx(Ae,{id:"apply-discount",checked:z,onCheckedChange:ce})]}),z&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(R,{htmlFor:"discount-slider",children:"Percentual de desconto"}),e.jsxs("span",{className:"font-medium text-primary",children:[w,"%"]})]}),e.jsx(Se,{id:"discount-slider",value:[w],min:0,max:30,step:1,onValueChange:([s])=>ie(s),className:"py-4"}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[e.jsx("span",{children:"0%"}),e.jsx("span",{children:"15%"}),e.jsx("span",{children:"30%"})]})]}),(o==null?void 0:o.price)&&e.jsxs("div",{className:"bg-muted/50 p-4 rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"PreÃ§o original:"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o.price/100)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Desconto (",w,"%):"]}),e.jsxs("span",{className:"text-green-600",children:["- ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o.price*w/100/100)]})]}),e.jsx(V,{className:"my-2"}),e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("span",{children:"PreÃ§o final:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format((o.price-o.price*w/100)/100)})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"O desconto Ã© aplicado apenas sobre o valor do serviÃ§o, a taxa da plataforma permanece a mesma."})]})]})]})})]}),e.jsxs(E,{className:"mb-6",children:[e.jsx(M,{children:e.jsx(T,{children:"ObservaÃ§Ãµes"})}),e.jsx(L,{children:e.jsx(Ce,{placeholder:"Adicione informaÃ§Ãµes importantes para o prestador (opcional)",value:a,onChange:s=>B(s.target.value),className:"resize-none",rows:3})})]}),e.jsxs("div",{className:"flex flex-col space-y-3",children:[e.jsxs(g,{onClick:pe,disabled:$,className:"w-full",size:"lg",children:[D.isPending&&e.jsx(U,{className:"mr-2 h-4 w-4 animate-spin"}),"Confirmar Agendamento"]}),e.jsxs(g,{variant:"outline",className:"w-full",onClick:ue,disabled:$||!c||!o,children:[e.jsx(He,{className:"mr-2 h-4 w-4"}),"Compartilhar no WhatsApp"]})]})]})]})}export{Ts as default};
