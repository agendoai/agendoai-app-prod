import{j as e}from"./ui-UIpCtT3r.js";import{r as l}from"./vendor-vA4cx1mx.js";import{u as ae,L as P,b as xe}from"./router-CxXythJb.js";import{j as fe,u as re,l as he,b as oe,X as ge,c as k,C as E,d as L,e as M,g as T,L as $,f as je,q as ye,i as ve,D as Ne,n as U}from"./index-BJ9Cw0LR.js";import{u as be}from"./useMutation-CDdW0pzE.js";import{B as j}from"./button-BvsVcTDx.js";import{T as we}from"./textarea-6aMtToLP.js";import{R as Ce,a as X}from"./radio-group-BgX2rSz9.js";import{L as R}from"./label-qfvszZNj.js";import{S as O}from"./separator-B7JIGNlt.js";import{S as Ie}from"./slider-BJ4aRTnI.js";import{S as Se}from"./switch-BjwSyAKP.js";import{a as Ae,S as Pe,b as ke,c as Ee,d as Le}from"./sheet-NdLuqHVB.js";import{A as G,a as Y,b as Z}from"./avatar-DEanbPY_.js";import{M as Me}from"./menu-B7gXVrLX.js";import{H as Te}from"./house-CCMYCVaH.js";import{S as Re}from"./search-ByWcnwgm.js";import{C as qe}from"./calendar-clock-C4lPo-cT.js";import{M as Be}from"./map-pin-D9hoaVWV.js";import{C as Fe}from"./circle-user-D4U5iR2t.js";import{s as ze}from"./whatsapp-CXCPK3xh.js";import{A as De}from"./arrow-left-EWHBe2nW.js";import{U as $e}from"./user-C2y4PfJ8.js";import{C as Ue}from"./calendar-tibBNAR3.js";import{C as Oe}from"./clock-BoQP0pJL.js";import{B as ee}from"./banknote-B9qNLEl6.js";import{C as V}from"./credit-card-CO61cKh_.js";import{Q as se}from"./qr-code-B1NQmKzq.js";import{P as Ve}from"./percent-CjOLIiK1.js";import{S as He}from"./share-2-B19OuGMQ.js";import{p as Ke}from"./parse-DkXBBKDI.js";import{f as Qe}from"./format-CGvBu07F.js";import{p as _e}from"./pt-BR-Cxqo7XV3.js";import"./index-BH3L9zMK.js";import"./circle-CxgECyF4.js";import"./index-BdQq_4o_.js";import"./en-US-xSPtgCq_.js";import"./addDays-BQ37Zmqx.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=fe("Tags",[["path",{d:"m15 5 6.3 6.3a2.4 2.4 0 0 1 0 3.4L17 19",key:"1cbfv1"}],["path",{d:"M9.586 5.586A2 2 0 0 0 8.172 5H3a1 1 0 0 0-1 1v5.172a2 2 0 0 0 .586 1.414L8.29 18.29a2.426 2.426 0 0 0 3.42 0l3.58-3.58a2.426 2.426 0 0 0 0-3.42z",key:"135mg7"}],["circle",{cx:"6.5",cy:"9.5",r:".5",fill:"currentColor",key:"5pm5xn"}]]);function We(){const{user:o,logoutMutation:H}=re(),{unreadCount:A}=he(),[f]=ae(),[g,u]=l.useState(!1),[q,te]=l.useState(!1),{toast:C}=oe(),I=()=>{if(!o||!o.name)return"U";const a=o.name.split(" ");return a.length===1?a[0][0].toUpperCase():(a[0][0]+a[a.length-1][0]).toUpperCase()},i=a=>f.startsWith(a),p=[{path:"/client/dashboard",label:"InÃ­cio",icon:e.jsx(Te,{size:20})},{path:"/client/search",label:"Buscar",icon:e.jsx(Re,{size:20})},{path:"/client/appointments",label:"Agendamentos",icon:e.jsx(qe,{size:20})},{path:"/client/provider-map",label:"Mapa",icon:e.jsx(Be,{size:20})},{path:"/client/profile",label:"Perfil",icon:e.jsx(Fe,{size:20})}],b=()=>{localStorage.removeItem("authToken"),sessionStorage.removeItem("authToken"),window.authToken&&(window.authToken=void 0),console.log("ðŸ”‘ Token removido diretamente do localStorage e sessionStorage"),C({title:"Logout realizado",description:"VocÃª saiu da sua conta com sucesso."}),setTimeout(()=>{console.log("ðŸ”„ Recarregando pÃ¡gina..."),window.location.reload()},500)};return e.jsx("header",{className:"sticky top-0 z-50 bg-white border-b border-gray-200",children:e.jsxs("div",{className:"container flex items-center justify-between h-14 px-4",children:[e.jsx(P,{href:"/client/dashboard",className:"flex items-center space-x-2",children:e.jsx("img",{src:"/logo.svg",alt:"AgendoAI",className:"h-8 w-auto"})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(Ae,{open:g,onOpenChange:u,children:[e.jsx(Pe,{asChild:!0,children:e.jsxs(j,{variant:"ghost",size:"icon",className:"md:hidden",children:[e.jsx(Me,{size:24}),e.jsx("span",{className:"sr-only",children:"Menu"})]})}),e.jsxs(ke,{side:"left",className:"p-0",children:[e.jsx(Ee,{className:"p-4 border-b",children:e.jsxs(Le,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Menu"}),e.jsx(j,{variant:"ghost",size:"icon",onClick:()=>u(!1),children:e.jsx(ge,{size:18})})]})}),o&&e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs(G,{children:[e.jsx(Y,{src:o.profileImage}),e.jsx(Z,{children:I()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:o.name||o.email}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Cliente"})]})]})}),e.jsx("nav",{className:"p-2",children:e.jsx("ul",{className:"space-y-1",children:p.map(a=>e.jsx("li",{children:e.jsx(P,{href:a.path,children:e.jsxs("a",{className:`flex items-center space-x-3 px-3 py-2 rounded-md text-sm ${i(a.path)?"bg-primary text-primary-foreground":"hover:bg-primary/10"}`,onClick:()=>u(!1),children:[a.icon,e.jsx("span",{children:a.label})]})})},a.path))})}),e.jsx("div",{className:"p-4 border-t mt-auto",children:e.jsx(j,{variant:"outline",className:"w-full",onClick:b,children:"Sair"})})]})]}),e.jsx("nav",{className:"hidden md:flex items-center space-x-1",children:p.map(a=>e.jsx(P,{href:a.path,children:e.jsxs("a",{className:`flex items-center space-x-1 px-3 py-2 rounded-md text-sm ${i(a.path)?"bg-primary text-primary-foreground":"hover:bg-primary/10"}`,children:[a.icon,e.jsx("span",{children:a.label})]})},a.path))}),e.jsx(P,{href:"/client/profile",children:e.jsx("a",{className:"flex items-center space-x-2",children:e.jsxs(G,{className:"h-8 w-8",children:[e.jsx(Y,{src:o==null?void 0:o.profileImage,alt:(o==null?void 0:o.name)||"UsuÃ¡rio"}),e.jsx(Z,{children:I()})]})})})]})]})})}function Rs(){const[,o]=ae(),{providerId:H,serviceId:A,date:f,startTime:g,endTime:u,availabilityId:q}=xe(),C=l.useMemo(()=>new URLSearchParams(window.location.search),[]).get("additionalServices"),I=l.useMemo(()=>C?C.split(",").map(s=>parseInt(s)).filter(s=>!isNaN(s)):[],[C]);l.useMemo(()=>[parseInt(A),...I],[A,I]);const i=parseInt(H),p=parseInt(A),b=q?parseInt(q):void 0,[a,ne]=l.useState(""),[y,B]=l.useState("money"),[S,K]=l.useState("offline"),[w,ie]=l.useState(0),[F,ce]=l.useState(!1),{toast:x}=oe(),{user:h}=re(),{data:v,isLoading:Q}=k({queryKey:["/api/payment-methods/available"],queryFn:()=>fetch("/api/payment-methods/available").then(s=>{if(!s.ok)throw new Error("Erro ao buscar mÃ©todos de pagamento");return s.json()})}),{data:d,isLoading:le}=k({queryKey:["/api/providers",i,"payment-methods"],queryFn:()=>U(`/providers/${i}/payment-methods`).then(s=>{if(!s.ok)throw new Error("Erro ao buscar mÃ©todos de pagamento do prestador");return s.json()}),enabled:!!i}),_=(()=>{try{const s=Ke(f,"yyyy-MM-dd",new Date);return Qe(s,"EEEE, dd 'de' MMMM 'de' yyyy",{locale:_e})}catch(s){return console.error("Erro ao formatar data:",s),f}})(),{data:c,isLoading:de}=k({queryKey:["/api/providers",i],queryFn:()=>(console.log(`Buscando dados do prestador para confirmaÃ§Ã£o: ${i}`),U(`/providers/${i}`).then(s=>{if(!s.ok)throw new Error(`Erro ao buscar prestador: ${s.status}`);return s.json()})),enabled:!!i}),{data:t,isLoading:me}=k({queryKey:["/api/services",p],queryFn:()=>(console.log(`Buscando serviÃ§o por ID: ${p}`),U(`/services/${p}`).then(s=>{if(!s.ok)throw new Error(`Erro ao buscar serviÃ§o: ${s.status}`);return s.json()})),enabled:!!p}),z=be({mutationFn:async s=>{const r=await ve("POST","/api/appointments",s);if(!r.ok){const N=await r.json();throw new Error(N.error||"Erro ao criar agendamento")}return r.json()},onSuccess:s=>{console.log("Agendamento criado com sucesso:",s),ye.invalidateQueries({queryKey:["/api/appointments"]}),x({title:"Agendamento confirmado!",description:"Seu agendamento foi registrado com sucesso."}),console.log("Resposta completa da API ao criar agendamento:",JSON.stringify(s));let r=null;if(s&&s.appointment&&s.appointment.id)r=s.appointment.id;else if(s&&s.id)r=s.id;else if(s&&typeof s=="object"){const N=n=>{if(!n||typeof n!="object")return null;if("id"in n&&typeof n.id=="number")return n.id;for(const J in n)if(typeof n[J]=="object"){const W=N(n[J]);if(W)return W}return null};r=N(s)}r?(console.log("Redirecionando para pÃ¡gina de sucesso com appointmentId:",r),o(`/client/booking-success?appointmentId=${r}`)):(console.error("Erro: ID do agendamento nÃ£o encontrado na resposta",s),x({title:"Erro de redirecionamento",description:"NÃ£o foi possÃ­vel acessar os detalhes do agendamento.",variant:"destructive"}),o("/client/appointments"))},onError:s=>{console.error("Erro ao criar agendamento:",s),x({title:"Erro ao agendar",description:s.message,variant:"destructive"})}});l.useEffect(()=>{if(h)console.log("UsuÃ¡rio autenticado, ID:",h.id,"Tipo:",h.userType||"nÃ£o especificado");else{console.log("UsuÃ¡rio nÃ£o estÃ¡ autenticado. Redirecionando para tela de login.");const s={providerId:i,serviceId:p,date:f,startTime:g,endTime:u,availabilityId:b};console.log("Salvando dados do agendamento para recuperaÃ§Ã£o pÃ³s-login:",s),sessionStorage.setItem("pendingBooking",JSON.stringify(s)),x({title:"AutenticaÃ§Ã£o necessÃ¡ria",description:"Ã‰ necessÃ¡rio estar logado para confirmar o agendamento. Redirecionando para o login...",variant:"default"}),setTimeout(()=>{o("/auth?redirect=booking")},1500)}},[h,i,p,f,g,u,b,o,x]);const pe=async()=>{if(!h){x({title:"UsuÃ¡rio nÃ£o autenticado",description:"VocÃª precisa estar logado para agendar.",variant:"destructive"}),sessionStorage.setItem("pendingBooking",JSON.stringify({providerId:i,serviceId:p,date:f,startTime:g,endTime:u,availabilityId:b})),o("/auth?redirect=booking");return}if(!c||!t){x({title:"Erro ao confirmar",description:"Dados incompletos para o agendamento.",variant:"destructive"});return}const s=v==null?void 0:v.find(n=>n.id===y);if((s==null?void 0:s.processor)==="asaas"&&(s==null?void 0:s.type)==="online")try{x({title:"Processando pagamento...",description:"Aguarde enquanto processamos seu pagamento."});const n=await Ne({customerId:h.id.toString(),providerId:i,serviceValue:t.price/100,billingType:y.includes("pix")?"PIX":"CREDIT_CARD",description:`Agendamento - ${t.name} com ${c.name||c.email}`,dueDate:f});if(n.success)x({title:"Pagamento processado!",description:"Pagamento realizado com sucesso. Criando agendamento..."});else throw new Error(n.message||"Erro ao processar pagamento")}catch(n){console.error("Erro no pagamento Asaas:",n),x({title:"Erro no pagamento",description:n.message||"NÃ£o foi possÃ­vel processar o pagamento. Tente novamente.",variant:"destructive"});return}const N={clientId:h.id,providerId:i,serviceId:p,date:f,startTime:g,endTime:u,notes:a,paymentMethod:y,availabilityId:b,discount:F?w:0};console.log("Dados do agendamento:",N),z.mutate(N)},ue=()=>{if(!c||!t)return;const s=`
      Agendei um serviÃ§o no AgendoAI!
      
      ðŸ“ ServiÃ§o: ${t.name}
      ðŸ‘¤ Prestador: ${c.name||c.email}
      ðŸ“… Data: ${_}
      ðŸ•’ HorÃ¡rio: ${g} - ${u}
      
      Baixe o AgendoAI e agende tambÃ©m!
      https://agendoai.com
    `;ze(s)},m=l.useMemo(()=>{if(!v||!d)return console.log("MÃ©todos de pagamento nÃ£o disponÃ­veis ainda"),[];console.log("Filtrando mÃ©todos de pagamento:",{availablePaymentMethods:v,providerPaymentMethods:d});const s=v.filter(r=>r.type==="offline"?!(r.id==="money"&&!d.acceptsCash||r.id==="card_local"&&!d.acceptsDebitCard&&!d.acceptsCreditCard||r.id==="pix_local"&&!d.acceptsPix||r.id==="transfer"&&!d.acceptsTransfer):r.type==="online"?r.processor==="stripe"&&!d.preferStripe?(console.log("MÃ©todo stripe rejeitado porque prestador nÃ£o prefere Stripe"),!1):r.processor==="asaas"&&!d.preferAsaas?(console.log("MÃ©todo asaas rejeitado porque prestador nÃ£o prefere Asaas"),!1):r.id.includes("card")&&!d.acceptsCreditCard?(console.log("MÃ©todo cartÃ£o rejeitado porque prestador nÃ£o aceita cartÃ£o de crÃ©dito"),!1):r.id.includes("pix")&&!d.acceptsPix?(console.log("MÃ©todo pix rejeitado porque prestador nÃ£o aceita PIX"),!1):!0:!0);return console.log("MÃ©todos filtrados:",s),s},[v,d]);l.useEffect(()=>{y?(m==null?void 0:m.length)>0&&!m.some(s=>s.id===y)&&B(m[0].id):B("money")},[m,y]);const D=de||me||z.isPending||Q||le;return e.jsxs("div",{className:"min-h-screen bg-white",children:[e.jsx(We,{}),e.jsxs("main",{className:"container px-4 py-8",children:[e.jsxs(j,{variant:"ghost",size:"sm",className:"mb-4",onClick:()=>window.history.back(),children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),"Voltar"]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Confirmar Agendamento"}),e.jsx("p",{className:"text-muted-foreground",children:"Verifique os detalhes e confirme seu agendamento"})]}),e.jsxs(E,{className:"mb-6",children:[e.jsx(L,{children:e.jsx(M,{children:"Detalhes do Agendamento"})}),e.jsx(T,{className:"space-y-4",children:D?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx($,{className:"h-6 w-6 animate-spin text-primary"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx($e,{className:"h-5 w-5 text-muted-foreground mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:(c==null?void 0:c.name)||(c==null?void 0:c.email)||"Prestador"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:(t==null?void 0:t.name)||"ServiÃ§o"})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ue,{className:"h-5 w-5 text-muted-foreground"}),e.jsx("p",{children:_})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Oe,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("p",{children:[g," - ",u]})]}),e.jsx(O,{}),e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("p",{children:"Total"}),e.jsx("p",{children:t?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t.price/100):"Carregando..."})]})]})})]}),e.jsxs(E,{className:"mb-6",children:[e.jsx(L,{children:e.jsx(M,{children:"Forma de Pagamento"})}),e.jsx(T,{children:Q?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx($,{className:"h-6 w-6 animate-spin text-primary"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between mb-4",children:[e.jsxs(j,{variant:S==="offline"?"default":"outline",size:"sm",className:"flex-1 mr-2",onClick:()=>K("offline"),disabled:!m.some(s=>s.type==="offline"),children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"No local"]}),e.jsxs(j,{variant:S==="online"?"default":"outline",size:"sm",className:"flex-1 ml-2",onClick:()=>K("online"),disabled:!m.some(s=>s.type==="online"),children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"Online"]})]}),e.jsx(O,{className:"my-4"}),e.jsxs(Ce,{value:y,onValueChange:B,className:"space-y-3",children:[S==="offline"?m.filter(s=>s.type==="offline").map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(X,{value:s.id,id:s.id}),e.jsxs(R,{htmlFor:s.id,className:"flex items-center",children:[s.id==="money"?e.jsx(ee,{className:"h-4 w-4 mr-2 text-muted-foreground"}):s.id==="pix_local"?e.jsx(se,{className:"h-4 w-4 mr-2 text-muted-foreground"}):e.jsx(V,{className:"h-4 w-4 mr-2 text-muted-foreground"}),s.name]})]},s.id)):m.filter(s=>s.type==="online").map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(X,{value:s.id,id:s.id}),e.jsxs(R,{htmlFor:s.id,className:"flex items-center",children:[s.id.includes("pix")?e.jsx(se,{className:"h-4 w-4 mr-2 text-muted-foreground"}):e.jsx(V,{className:"h-4 w-4 mr-2 text-muted-foreground"}),s.name,s.processor&&e.jsx("span",{className:"ml-2 text-xs bg-muted text-muted-foreground px-2 py-0.5 rounded-full",children:s.processor==="stripe"?"Stripe":"Asaas"})]})]},s.id)),S==="offline"&&!m.some(s=>s.type==="offline")&&e.jsx("div",{className:"text-center p-4 border border-dashed rounded-md",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Este prestador nÃ£o aceita pagamentos no local."})}),S==="online"&&!m.some(s=>s.type==="online")&&e.jsx("div",{className:"text-center p-4 border border-dashed rounded-md",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Pagamentos online nÃ£o estÃ£o disponÃ­veis para este prestador."})})]})]})})]}),h&&h.userType==="provider"&&e.jsxs(E,{className:"mb-6",children:[e.jsxs(L,{children:[e.jsxs(M,{className:"flex items-center",children:[e.jsx(Ve,{className:"h-5 w-5 mr-2 text-primary"}),"Aplicar Desconto"]}),e.jsx(je,{children:"Conceda um desconto especial para este cliente"})]}),e.jsx(T,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(R,{htmlFor:"apply-discount",className:"flex items-center cursor-pointer",children:[e.jsx(Je,{className:"h-4 w-4 mr-2 text-muted-foreground"}),"Ativar desconto"]}),e.jsx(Se,{id:"apply-discount",checked:F,onCheckedChange:ce})]}),F&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(R,{htmlFor:"discount-slider",children:"Percentual de desconto"}),e.jsxs("span",{className:"font-medium text-primary",children:[w,"%"]})]}),e.jsx(Ie,{id:"discount-slider",value:[w],min:0,max:30,step:1,onValueChange:([s])=>ie(s),className:"py-4"}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[e.jsx("span",{children:"0%"}),e.jsx("span",{children:"15%"}),e.jsx("span",{children:"30%"})]})]}),(t==null?void 0:t.price)&&e.jsxs("div",{className:"bg-muted/50 p-4 rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"PreÃ§o original:"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t.price/100)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Desconto (",w,"%):"]}),e.jsxs("span",{className:"text-green-600",children:["- ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t.price*w/100/100)]})]}),e.jsx(O,{className:"my-2"}),e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("span",{children:"PreÃ§o final:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format((t.price-t.price*w/100)/100)})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"O desconto Ã© aplicado apenas sobre o valor do serviÃ§o, a taxa da plataforma permanece a mesma."})]})]})]})})]}),e.jsxs(E,{className:"mb-6",children:[e.jsx(L,{children:e.jsx(M,{children:"ObservaÃ§Ãµes"})}),e.jsx(T,{children:e.jsx(we,{placeholder:"Adicione informaÃ§Ãµes importantes para o prestador (opcional)",value:a,onChange:s=>ne(s.target.value),className:"resize-none",rows:3})})]}),e.jsxs("div",{className:"flex flex-col space-y-3",children:[e.jsxs(j,{onClick:pe,disabled:D,className:"w-full",size:"lg",children:[z.isPending&&e.jsx($,{className:"mr-2 h-4 w-4 animate-spin"}),"Confirmar Agendamento"]}),e.jsxs(j,{variant:"outline",className:"w-full",onClick:ue,disabled:D||!c||!t,children:[e.jsx(He,{className:"mr-2 h-4 w-4"}),"Compartilhar no WhatsApp"]})]})]})]})}export{Rs as default};
