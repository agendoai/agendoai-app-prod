import{a as J,s as X,r as h,c as U,d as k,j as e,H as W,o as Y,C as A,f as D,g as P,h as E,i as M,y as Z,k as _,q as ee,l as se}from"./index-DFO2lo2s.js";import{u as ae}from"./useMutation-BIXw1p8a.js";import{C as g}from"./client-layout-Dqh0s42V.js";import{B as d}from"./button-6IH7luFD.js";import{S as T}from"./separator-Cw00ASEU.js";import{A as re,a as oe,b as ie}from"./avatar-CVSf1ztN.js";import{A as ne,a as te}from"./alert-NIGMftih.js";import{R as de,a as le}from"./radio-group-DYdLOZBv.js";import{L as ce}from"./label-ByXqB0vV.js";import{D as me,a as pe,b as xe,c as ue,d as he}from"./dialog-eRBlhqVz.js";import{p as fe}from"./parseISO-C4T3oArM.js";import{A as q}from"./arrow-left-DxjewkX7.js";import{C as je}from"./circle-x-sJwzAusc.js";import{I as L}from"./info-Dr6QlzrX.js";import{M as ve}from"./map-pin-wlEWBw89.js";import{P as ge}from"./phone-PqoFJEyq.js";import{C as Ne}from"./calendar-CXCri533.js";import{C as ye}from"./clock-BQ1l0DXv.js";import{C as be}from"./credit-card-By0IdnTO.js";import{C as Ce}from"./circle-check-BuMpd2MK.js";import{f as we}from"./format-CGvBu07F.js";import{p as Ie}from"./pt-BR-Cxqo7XV3.js";import"./navbar-BoNMuwo_.js";import"./proxy-BltBotVH.js";import"./house-sGd4nDnu.js";import"./search-CMPUhstB.js";import"./calendar-check-CDRCjfO9.js";import"./user-WwS7npix.js";import"./index-CWnO1h2h.js";import"./index-zokK3oQV.js";import"./index-BZw1vT_C.js";import"./index-heHCkeO_.js";import"./index-BGiioUCj.js";import"./circle-AYNPgkgN.js";import"./index-O3IU6Cgx.js";import"./index-BEl4sio8.js";import"./en-US-xSPtgCq_.js";function ls(){var w;const[,N]=J(),{providerId:F,serviceId:B,date:f,startTime:y,endTime:b,availabilityId:R="0"}=X(),[l,C]=h.useState(null),{toast:c}=U(),m=parseInt(F),p=parseInt(B),O=parseInt(R),V=f?we(fe(f),"EEEE, d 'de' MMMM 'de' yyyy",{locale:Ie}):"",{data:i,isLoading:H}=k({queryKey:["/api/providers",m],queryFn:()=>fetch(`/api/providers/${m}`).then(s=>{if(!s.ok)throw new Error("Erro ao buscar dados do prestador");return s.json()}),enabled:!isNaN(m)}),{data:n,isLoading:$}=k({queryKey:["/api/services",p],queryFn:()=>fetch(`/api/services/${p}`).then(s=>{if(!s.ok)throw new Error("Erro ao buscar dados do serviço");return s.json()}),enabled:!isNaN(p)});h.useEffect(()=>{var s,a;(a=(s=i==null?void 0:i.settings)==null?void 0:s.paymentMethods)!=null&&a.length&&C(i.settings.paymentMethods[0].id)},[i]);const[z,K]=h.useState([]),[Q,j]=h.useState(!1),x=ae({mutationFn:async s=>(await se("POST","/api/appointments",s)).json(),onSuccess:s=>{c({title:"Agendamento confirmado!",description:"Seu agendamento foi realizado com sucesso."}),s.blockedTimeSlots&&s.blockedTimeSlots.length>0&&(K(s.blockedTimeSlots),j(!0)),ee.invalidateQueries({queryKey:["/api/appointments"]}),setTimeout(()=>{console.log("Resposta completa da API ao criar agendamento:",JSON.stringify(s));let a=null;if(s&&s.appointment&&s.appointment.id)a=s.appointment.id,console.log("ID encontrado na estrutura data.appointment.id:",a);else if(s&&s.id)a=s.id,console.log("ID encontrado na estrutura data.id:",a);else if(s&&typeof s=="object"){const I=(o,v="")=>{if(!o||typeof o!="object")return null;if("id"in o&&typeof o.id=="number")return console.log(`ID encontrado em ${v||"raiz"}.id:`,o.id),o.id;for(const u in o)if(typeof o[u]=="object"){const S=I(o[u],v?`${v}.${u}`:u);if(S)return S}return null};a=I(s)}a?(console.log("Redirecionando para página de sucesso com appointmentId:",a),N(`/client/booking-success?appointmentId=${a}`)):(console.error("Erro: ID do agendamento não encontrado na resposta",s),c({title:"Erro de redirecionamento",description:"Não foi possível acessar os detalhes do agendamento. Verifique seus agendamentos.",variant:"destructive"}),N("/client/appointments"))},3e3)},onError:s=>{c({title:"Erro ao agendar",description:s.message||"Não foi possível realizar o agendamento. Tente novamente.",variant:"destructive"})}}),G=()=>{if(!l){c({title:"Selecione um método de pagamento",description:"É necessário selecionar um método de pagamento para continuar.",variant:"destructive"});return}x.mutate({providerId:m,serviceId:p,date:f,startTime:y,endTime:b,paymentMethod:l,availabilityId:O||void 0})};if(H||$)return e.jsx(g,{children:e.jsx("div",{className:"container py-8",children:e.jsx("div",{className:"flex justify-center items-center min-h-[50vh]",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"})})})});if(!i||!n)return e.jsx(g,{children:e.jsx("div",{className:"container py-8",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-destructive",children:"Informações não encontradas"}),e.jsx("p",{className:"text-muted-foreground",children:"O prestador ou serviço que você está procurando não existe ou não está mais disponível."}),e.jsxs(d,{onClick:()=>window.history.back(),variant:"outline",children:[e.jsx(q,{className:"mr-2 h-4 w-4"}),"Voltar"]})]})})});const t=i.user,r=i.settings;return e.jsxs(e.Fragment,{children:[e.jsx(W,{children:e.jsx("title",{children:"Confirmar Agendamento | AgendoAI"})}),e.jsx(me,{open:Q,onOpenChange:j,children:e.jsxs(pe,{className:"sm:max-w-md",children:[e.jsxs(xe,{children:[e.jsxs(ue,{className:"flex items-center",children:[e.jsx(Y,{className:"h-5 w-5 mr-2 text-amber-500"}),"Horários Indisponíveis"]}),e.jsx(he,{children:"Seu agendamento foi confirmado com sucesso! Os seguintes horários ficaram indisponíveis após seu agendamento:"})]}),e.jsx("div",{className:"space-y-3 my-4 max-h-60 overflow-y-auto",children:z.map((s,a)=>e.jsxs("div",{className:"flex items-center border rounded p-2 bg-muted",children:[e.jsx(je,{className:"h-4 w-4 mr-2 text-destructive"}),e.jsxs("span",{children:[s.startTime," - ",s.endTime]})]},a))}),e.jsxs("div",{className:"mt-4 bg-muted p-3 rounded-md text-sm",children:[e.jsxs("p",{className:"font-medium flex items-center mb-1",children:[e.jsx(L,{className:"h-4 w-4 mr-1 text-blue-500"}),"Por que isso acontece?"]}),e.jsx("p",{children:"Quando você agenda um serviço, outros horários próximos podem ficar indisponíveis para garantir que o prestador tenha tempo adequado para atender todos os clientes."})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx(d,{onClick:()=>j(!1),children:"Entendi"})})]})}),e.jsx(g,{children:e.jsxs("div",{className:"container py-6 space-y-6 max-w-4xl",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsxs(d,{variant:"ghost",onClick:()=>window.history.back(),className:"mr-4",children:[e.jsx(q,{className:"mr-2 h-4 w-4"}),"Voltar"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"Confirmar Agendamento"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(A,{className:"md:col-span-2",children:[e.jsxs(D,{children:[e.jsx(P,{className:"text-xl",children:"Detalhes do Agendamento"}),e.jsx(E,{children:"Confira as informações do seu agendamento antes de confirmar"})]}),e.jsx(M,{className:"space-y-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsxs(re,{className:"h-16 w-16 rounded-lg border",children:[e.jsx(oe,{src:t.profileImage||void 0,alt:t.name}),e.jsx(ie,{className:"rounded-lg bg-primary/10 text-xl",children:((w=t.name)==null?void 0:w.charAt(0))||"P"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-lg",children:(r==null?void 0:r.businessName)||t.name}),e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground mt-1",children:[e.jsx(ve,{className:"h-3.5 w-3.5 mr-1"}),e.jsx("span",{children:(r==null?void 0:r.address)||"Endereço não informado"})]}),e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground mt-1",children:[e.jsx(ge,{className:"h-3.5 w-3.5 mr-1"}),e.jsx("span",{children:t.phone||"Telefone não informado"})]})]})]}),e.jsx(T,{}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium",children:"Serviço"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"bg-muted rounded-lg p-2 mr-3",children:e.jsx(Ne,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:n.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Duração: ",n.duration," minutos"]})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium",children:"Data e Horário"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"bg-muted rounded-lg p-2 mr-3",children:e.jsx(ye,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium capitalize",children:V}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[y," - ",b]})]})]})]})]}),e.jsx(T,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium",children:"Valor do Serviço"}),e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("span",{children:"Valor total"}),e.jsx("span",{className:"text-lg",children:Z(n.price||0)})]}),n.price>0&&e.jsxs(ne,{className:"bg-muted/50 border-muted-foreground/20",children:[e.jsx(L,{className:"h-4 w-4"}),e.jsx(te,{children:"O pagamento será realizado diretamente ao prestador no momento do serviço."})]})]})]})})]}),e.jsxs(A,{children:[e.jsxs(D,{children:[e.jsx(P,{className:"text-lg",children:"Pagamento"}),e.jsx(E,{children:"Selecione como deseja pagar"})]}),e.jsx(M,{children:r!=null&&r.paymentMethods&&r.paymentMethods.length>0?e.jsx(de,{value:l||void 0,onValueChange:C,className:"space-y-3",children:r.paymentMethods.map(s=>e.jsxs("div",{className:"flex items-center space-x-2 border rounded-md p-3 cursor-pointer hover:bg-muted",children:[e.jsx(le,{value:s.id,id:s.id}),e.jsxs(ce,{htmlFor:s.id,className:"flex items-center cursor-pointer flex-1",children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),e.jsx("span",{children:s.name})]})]},s.id))}):e.jsx("div",{className:"text-center py-4 text-muted-foreground",children:e.jsx("p",{children:"Nenhum método de pagamento disponível"})})}),e.jsxs(_,{className:"flex flex-col space-y-4",children:[e.jsx(d,{onClick:G,disabled:x.isPending||!l,className:"w-full",children:x.isPending?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-b-transparent mr-2"}),"Processando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"}),"Confirmar Agendamento"]})}),e.jsx(d,{variant:"outline",onClick:()=>window.history.back(),className:"w-full",disabled:x.isPending,children:"Voltar"})]})]})]})]})})]})}export{ls as default};
