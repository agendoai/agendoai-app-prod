import{j as e}from"./ui-UIpCtT3r.js";import{r as h}from"./vendor-vA4cx1mx.js";import{b as X,c as k,B as d,p as U,m as W,C as A,d as D,e as P,f as E,g as M,r as Y,h as Z,q as _,i as ee,n as T}from"./index-DMVSlINz.js";import{u as se,b as ae}from"./router-CxXythJb.js";import{u as re}from"./useMutation-mYWno7MC.js";import{C as g}from"./client-layout-DcnrflWl.js";import{S as q}from"./separator-D_RfrPgK.js";import{A as oe,a as ie,b as ne}from"./avatar-DJ_tL6P_.js";import{A as te,a as de}from"./alert-93oPSpR2.js";import{R as le,a as ce}from"./radio-group-BopDKadC.js";import{L as me}from"./label-DJxjY-7j.js";import{D as pe,a as xe,b as ue,c as he,d as fe}from"./dialog-Ct2TP9w5.js";import{p as je}from"./parseISO-C4T3oArM.js";import{A as L}from"./arrow-left-3dZ_zEs-.js";import{C as ve}from"./circle-x-DeTx4Uam.js";import{I as F}from"./info-BMDDCGgY.js";import{M as ge}from"./map-pin-BJouWYuW.js";import{P as Ne}from"./phone-CDpJ8Rux.js";import{C as ye}from"./calendar-CYlMr0qt.js";import{C as be}from"./clock-DluLCsci.js";import{C as Ce}from"./credit-card-DTBtIUOk.js";import{C as we}from"./circle-check-BcKFyPGu.js";import{f as Ie}from"./format-CGvBu07F.js";import{p as Se}from"./pt-BR-Cxqo7XV3.js";import"./navbar-5CcLqczq.js";import"./proxy-CAhTMUof.js";import"./search-0bFur5DB.js";import"./calendar-check-DBfSly3E.js";import"./user-DxXpbN3a.js";import"./index-BH3L9zMK.js";import"./circle-CRjqYs4g.js";import"./en-US-xSPtgCq_.js";function is(){var w;const[,N]=se(),{providerId:B,serviceId:R,date:f,startTime:y,endTime:b,availabilityId:O="0"}=ae(),[l,C]=h.useState(null),{toast:c}=X(),m=parseInt(B),p=parseInt(R),V=parseInt(O),$=f?Ie(je(f),"EEEE, d 'de' MMMM 'de' yyyy",{locale:Se}):"",{data:i,isLoading:z}=k({queryKey:["/api/providers",m],queryFn:()=>T(`/providers/${m}`).then(s=>{if(!s.ok)throw new Error("Erro ao buscar dados do prestador");return s.json()}),enabled:!isNaN(m)}),{data:n,isLoading:H}=k({queryKey:["/api/services",p],queryFn:()=>T(`/services/${p}`).then(s=>{if(!s.ok)throw new Error("Erro ao buscar dados do serviço");return s.json()}),enabled:!isNaN(p)});h.useEffect(()=>{var s,a;(a=(s=i==null?void 0:i.settings)==null?void 0:s.paymentMethods)!=null&&a.length&&C(i.settings.paymentMethods[0].id)},[i]);const[K,Q]=h.useState([]),[G,j]=h.useState(!1),x=re({mutationFn:async s=>(await ee("POST","/api/appointments",s)).json(),onSuccess:s=>{c({title:"Agendamento confirmado!",description:"Seu agendamento foi realizado com sucesso."}),s.blockedTimeSlots&&s.blockedTimeSlots.length>0&&(Q(s.blockedTimeSlots),j(!0)),_.invalidateQueries({queryKey:["/api/appointments"]}),setTimeout(()=>{console.log("Resposta completa da API ao criar agendamento:",JSON.stringify(s));let a=null;if(s&&s.appointment&&s.appointment.id)a=s.appointment.id,console.log("ID encontrado na estrutura data.appointment.id:",a);else if(s&&s.id)a=s.id,console.log("ID encontrado na estrutura data.id:",a);else if(s&&typeof s=="object"){const I=(o,v="")=>{if(!o||typeof o!="object")return null;if("id"in o&&typeof o.id=="number")return console.log(`ID encontrado em ${v||"raiz"}.id:`,o.id),o.id;for(const u in o)if(typeof o[u]=="object"){const S=I(o[u],v?`${v}.${u}`:u);if(S)return S}return null};a=I(s)}a?(console.log("Redirecionando para página de sucesso com appointmentId:",a),N(`/client/booking-success?appointmentId=${a}`)):(console.error("Erro: ID do agendamento não encontrado na resposta",s),c({title:"Erro de redirecionamento",description:"Não foi possível acessar os detalhes do agendamento. Verifique seus agendamentos.",variant:"destructive"}),N("/client/appointments"))},3e3)},onError:s=>{c({title:"Erro ao agendar",description:s.message||"Não foi possível realizar o agendamento. Tente novamente.",variant:"destructive"})}}),J=()=>{if(!l){c({title:"Selecione um método de pagamento",description:"É necessário selecionar um método de pagamento para continuar.",variant:"destructive"});return}x.mutate({providerId:m,serviceId:p,date:f,startTime:y,endTime:b,paymentMethod:l,availabilityId:V||void 0})};if(z||H)return e.jsx(g,{children:e.jsx("div",{className:"container py-8",children:e.jsx("div",{className:"flex justify-center items-center min-h-[50vh]",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"})})})});if(!i||!n)return e.jsx(g,{children:e.jsx("div",{className:"container py-8",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-destructive",children:"Informações não encontradas"}),e.jsx("p",{className:"text-muted-foreground",children:"O prestador ou serviço que você está procurando não existe ou não está mais disponível."}),e.jsxs(d,{onClick:()=>window.history.back(),variant:"outline",children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Voltar"]})]})})});const t=i.user,r=i.settings;return e.jsxs(e.Fragment,{children:[e.jsx(U,{children:e.jsx("title",{children:"Confirmar Agendamento | AgendoAI"})}),e.jsx(pe,{open:G,onOpenChange:j,children:e.jsxs(xe,{className:"sm:max-w-md",children:[e.jsxs(ue,{children:[e.jsxs(he,{className:"flex items-center",children:[e.jsx(W,{className:"h-5 w-5 mr-2 text-amber-500"}),"Horários Indisponíveis"]}),e.jsx(fe,{children:"Seu agendamento foi confirmado com sucesso! Os seguintes horários ficaram indisponíveis após seu agendamento:"})]}),e.jsx("div",{className:"space-y-3 my-4 max-h-60 overflow-y-auto",children:K.map((s,a)=>e.jsxs("div",{className:"flex items-center border rounded p-2 bg-muted",children:[e.jsx(ve,{className:"h-4 w-4 mr-2 text-destructive"}),e.jsxs("span",{children:[s.startTime," - ",s.endTime]})]},a))}),e.jsxs("div",{className:"mt-4 bg-muted p-3 rounded-md text-sm",children:[e.jsxs("p",{className:"font-medium flex items-center mb-1",children:[e.jsx(F,{className:"h-4 w-4 mr-1 text-blue-500"}),"Por que isso acontece?"]}),e.jsx("p",{children:"Quando você agenda um serviço, outros horários próximos podem ficar indisponíveis para garantir que o prestador tenha tempo adequado para atender todos os clientes."})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx(d,{onClick:()=>j(!1),children:"Entendi"})})]})}),e.jsx(g,{children:e.jsxs("div",{className:"container py-6 space-y-6 max-w-4xl",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsxs(d,{variant:"ghost",onClick:()=>window.history.back(),className:"mr-4",children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Voltar"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"Confirmar Agendamento"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(A,{className:"md:col-span-2",children:[e.jsxs(D,{children:[e.jsx(P,{className:"text-xl",children:"Detalhes do Agendamento"}),e.jsx(E,{children:"Confira as informações do seu agendamento antes de confirmar"})]}),e.jsx(M,{className:"space-y-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsxs(oe,{className:"h-16 w-16 rounded-lg border",children:[e.jsx(ie,{src:t.profileImage||void 0,alt:t.name}),e.jsx(ne,{className:"rounded-lg bg-primary/10 text-xl",children:((w=t.name)==null?void 0:w.charAt(0))||"P"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-lg",children:(r==null?void 0:r.businessName)||t.name}),e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground mt-1",children:[e.jsx(ge,{className:"h-3.5 w-3.5 mr-1"}),e.jsx("span",{children:(r==null?void 0:r.address)||"Endereço não informado"})]}),e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground mt-1",children:[e.jsx(Ne,{className:"h-3.5 w-3.5 mr-1"}),e.jsx("span",{children:t.phone||"Telefone não informado"})]})]})]}),e.jsx(q,{}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium",children:"Serviço"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"bg-muted rounded-lg p-2 mr-3",children:e.jsx(ye,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:n.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Duração: ",n.duration," minutos"]})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium",children:"Data e Horário"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"bg-muted rounded-lg p-2 mr-3",children:e.jsx(be,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium capitalize",children:$}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[y," - ",b]})]})]})]})]}),e.jsx(q,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium",children:"Valor do Serviço"}),e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("span",{children:"Valor total"}),e.jsx("span",{className:"text-lg",children:Y(n.price||0)})]}),n.price>0&&e.jsxs(te,{className:"bg-muted/50 border-muted-foreground/20",children:[e.jsx(F,{className:"h-4 w-4"}),e.jsx(de,{children:"O pagamento será realizado diretamente ao prestador no momento do serviço."})]})]})]})})]}),e.jsxs(A,{children:[e.jsxs(D,{children:[e.jsx(P,{className:"text-lg",children:"Pagamento"}),e.jsx(E,{children:"Selecione como deseja pagar"})]}),e.jsx(M,{children:r!=null&&r.paymentMethods&&r.paymentMethods.length>0?e.jsx(le,{value:l||void 0,onValueChange:C,className:"space-y-3",children:r.paymentMethods.map(s=>e.jsxs("div",{className:"flex items-center space-x-2 border rounded-md p-3 cursor-pointer hover:bg-muted",children:[e.jsx(ce,{value:s.id,id:s.id}),e.jsxs(me,{htmlFor:s.id,className:"flex items-center cursor-pointer flex-1",children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),e.jsx("span",{children:s.name})]})]},s.id))}):e.jsx("div",{className:"text-center py-4 text-muted-foreground",children:e.jsx("p",{children:"Nenhum método de pagamento disponível"})})}),e.jsxs(Z,{className:"flex flex-col space-y-4",children:[e.jsx(d,{onClick:J,disabled:x.isPending||!l,className:"w-full",children:x.isPending?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-b-transparent mr-2"}),"Processando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(we,{className:"mr-2 h-4 w-4"}),"Confirmar Agendamento"]})}),e.jsx(d,{variant:"outline",onClick:()=>window.history.back(),className:"w-full",disabled:x.isPending,children:"Voltar"})]})]})]})]})})]})}export{is as default};
