import{m as pe,r as m,u as ae,a as re,j as e,L as P,X as ue,s as xe,c as fe,d as E,C as M,f as k,g as L,i as R,e as $,h as he,q as je,l as ge,N as ye}from"./index-DOe1OCu1.js";import{u as ve}from"./useMutation-Lmj9MX3Y.js";import{B as g}from"./button-C168b4m4.js";import{T as Ne}from"./textarea-D8qc73Fv.js";import{R as be,a as X}from"./radio-group-qCq92n-C.js";import{L as q}from"./label-MMklymaS.js";import{S as U}from"./separator-qDlnMeSp.js";import{S as we}from"./slider-BWlmJnLs.js";import{S as Ce}from"./switch-CGdZOur1.js";import{a as Ie,S as Se,b as Ae,c as Pe,d as Ee}from"./sheet-B7ZKKDV6.js";import{A as G,a as Y,b as Z}from"./avatar-DkIWG9bC.js";import{M as Me}from"./menu-ylsVJAGl.js";import{H as ke}from"./house-Calz6FJi.js";import{S as Le}from"./search-Bjz8DxPP.js";import{C as Re}from"./calendar-clock-CxGiorhk.js";import{M as qe}from"./map-pin-Z18Glv-N.js";import{C as Be}from"./circle-user-CKawu8ug.js";import{s as Te}from"./whatsapp-CXCPK3xh.js";import{A as Fe}from"./arrow-left-BPt4aJQo.js";import{U as ze}from"./user-BQOYdOBU.js";import{C as De}from"./calendar-Mn3IWFfL.js";import{C as $e}from"./clock-CVsS3BCD.js";import{B as ee}from"./banknote-ByVxHJ4Q.js";import{C as O}from"./credit-card-DtANwWGP.js";import{Q as se}from"./qr-code-Bbjbmpdo.js";import{P as Ue}from"./percent-CITLSmPi.js";import{S as Oe}from"./share-2-BYcRmu4H.js";import{p as He}from"./parse-DkXBBKDI.js";import{f as Ve}from"./format-CGvBu07F.js";import{p as Ke}from"./pt-BR-Cxqo7XV3.js";import"./index-DbsNQ1RS.js";import"./index-CQF81cx3.js";import"./index-DdZceiuF.js";import"./index-tIxYtZzE.js";import"./index-CCWTWNPs.js";import"./circle-DjQT6JQX.js";import"./index-BdQq_4o_.js";import"./index-DxOiueDc.js";import"./index-CtQ14QdP.js";import"./en-US-xSPtgCq_.js";import"./addDays-BQ37Zmqx.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=pe("Tags",[["path",{d:"m15 5 6.3 6.3a2.4 2.4 0 0 1 0 3.4L17 19",key:"1cbfv1"}],["path",{d:"M9.586 5.586A2 2 0 0 0 8.172 5H3a1 1 0 0 0-1 1v5.172a2 2 0 0 0 .586 1.414L8.29 18.29a2.426 2.426 0 0 0 3.42 0l3.58-3.58a2.426 2.426 0 0 0 0-3.42z",key:"135mg7"}],["circle",{cx:"6.5",cy:"9.5",r:".5",fill:"currentColor",key:"5pm5xn"}]]);function _e(){const[y,w]=m.useState(!1),{user:n,logoutMutation:u}=ae(),[h]=re(),x=()=>{if(!n||!n.name)return"U";const a=n.name.split(" ");return a.length===1?a[0][0].toUpperCase():(a[0][0]+a[a.length-1][0]).toUpperCase()},I=a=>h.startsWith(a),B=[{path:"/client/dashboard",label:"InÃ­cio",icon:e.jsx(ke,{size:20})},{path:"/client/search",label:"Buscar",icon:e.jsx(Le,{size:20})},{path:"/client/appointments",label:"Agendamentos",icon:e.jsx(Re,{size:20})},{path:"/client/provider-map",label:"Mapa",icon:e.jsx(qe,{size:20})},{path:"/client/profile",label:"Perfil",icon:e.jsx(Be,{size:20})}];return e.jsx("header",{className:"sticky top-0 z-50 bg-white border-b border-gray-200",children:e.jsxs("div",{className:"container flex items-center justify-between h-14 px-4",children:[e.jsx(P,{href:"/client/dashboard",className:"flex items-center space-x-2",children:e.jsx("img",{src:"/logo.svg",alt:"AgendoAI",className:"h-8 w-auto"})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(Ie,{open:y,onOpenChange:w,children:[e.jsx(Se,{asChild:!0,children:e.jsxs(g,{variant:"ghost",size:"icon",className:"md:hidden",children:[e.jsx(Me,{size:24}),e.jsx("span",{className:"sr-only",children:"Menu"})]})}),e.jsxs(Ae,{side:"left",className:"p-0",children:[e.jsx(Pe,{className:"p-4 border-b",children:e.jsxs(Ee,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Menu"}),e.jsx(g,{variant:"ghost",size:"icon",onClick:()=>w(!1),children:e.jsx(ue,{size:18})})]})}),n&&e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs(G,{children:[e.jsx(Y,{src:n.profileImage}),e.jsx(Z,{children:x()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:n.name||n.email}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Cliente"})]})]})}),e.jsx("nav",{className:"p-2",children:e.jsx("ul",{className:"space-y-1",children:B.map(a=>e.jsx("li",{children:e.jsx(P,{href:a.path,children:e.jsxs("a",{className:`flex items-center space-x-3 px-3 py-2 rounded-md text-sm ${I(a.path)?"bg-primary text-primary-foreground":"hover:bg-primary/10"}`,onClick:()=>w(!1),children:[a.icon,e.jsx("span",{children:a.label})]})})},a.path))})}),e.jsx("div",{className:"p-4 border-t mt-auto",children:e.jsx(g,{variant:"outline",className:"w-full",onClick:()=>{u.mutate(),w(!1)},children:"Sair"})})]})]}),e.jsx("nav",{className:"hidden md:flex items-center space-x-1",children:B.map(a=>e.jsx(P,{href:a.path,children:e.jsxs("a",{className:`flex items-center space-x-1 px-3 py-2 rounded-md text-sm ${I(a.path)?"bg-primary text-primary-foreground":"hover:bg-primary/10"}`,children:[a.icon,e.jsx("span",{children:a.label})]})},a.path))}),e.jsx(P,{href:"/client/profile",children:e.jsx("a",{className:"flex items-center space-x-2",children:e.jsxs(G,{className:"h-8 w-8",children:[e.jsx(Y,{src:n==null?void 0:n.profileImage,alt:(n==null?void 0:n.name)||"UsuÃ¡rio"}),e.jsx(Z,{children:x()})]})})})]})]})})}function Bs(){const[,y]=re(),{providerId:w,serviceId:n,date:u,startTime:h,endTime:x,availabilityId:I}=xe(),a=m.useMemo(()=>new URLSearchParams(window.location.search),[]).get("additionalServices"),H=m.useMemo(()=>a?a.split(",").map(s=>parseInt(s)).filter(s=>!isNaN(s)):[],[a]);m.useMemo(()=>[parseInt(n),...H],[n,H]);const c=parseInt(w),j=parseInt(n),A=I?parseInt(I):void 0,[V,te]=m.useState(""),[v,T]=m.useState("money"),[S,K]=m.useState("offline"),[C,ne]=m.useState(0),[F,oe]=m.useState(!1),{toast:p}=fe(),{user:f}=ae(),{data:N,isLoading:Q}=E({queryKey:["/api/payment-methods/available"],queryFn:()=>fetch("/api/payment-methods/available").then(s=>{if(!s.ok)throw new Error("Erro ao buscar mÃ©todos de pagamento");return s.json()})}),{data:l,isLoading:ie}=E({queryKey:["/api/providers",c,"payment-methods"],queryFn:()=>fetch(`/api/providers/${c}/payment-methods`).then(s=>{if(!s.ok)throw new Error("Erro ao buscar mÃ©todos de pagamento do prestador");return s.json()}),enabled:!!c}),_=(()=>{try{const s=He(u,"yyyy-MM-dd",new Date);return Ve(s,"EEEE, dd 'de' MMMM 'de' yyyy",{locale:Ke})}catch(s){return console.error("Erro ao formatar data:",s),u}})(),{data:i,isLoading:ce}=E({queryKey:["/api/providers",c],queryFn:()=>(console.log(`Buscando dados do prestador para confirmaÃ§Ã£o: ${c}`),fetch(`/api/providers/${c}`).then(s=>{if(!s.ok)throw new Error(`Erro ao buscar prestador: ${s.status}`);return s.json()})),enabled:!!c}),{data:t,isLoading:le}=E({queryKey:["/api/services",j],queryFn:()=>(console.log(`Buscando serviÃ§o por ID: ${j}`),fetch(`/api/services/${j}`).then(s=>{if(!s.ok)throw new Error(`Erro ao buscar serviÃ§o: ${s.status}`);return s.json()})),enabled:!!j}),z=ve({mutationFn:async s=>{const r=await ge("POST","/api/appointments",s);if(!r.ok){const b=await r.json();throw new Error(b.error||"Erro ao criar agendamento")}return r.json()},onSuccess:s=>{console.log("Agendamento criado com sucesso:",s),je.invalidateQueries({queryKey:["/api/appointments"]}),p({title:"Agendamento confirmado!",description:"Seu agendamento foi registrado com sucesso."}),console.log("Resposta completa da API ao criar agendamento:",JSON.stringify(s));let r=null;if(s&&s.appointment&&s.appointment.id)r=s.appointment.id;else if(s&&s.id)r=s.id;else if(s&&typeof s=="object"){const b=o=>{if(!o||typeof o!="object")return null;if("id"in o&&typeof o.id=="number")return o.id;for(const J in o)if(typeof o[J]=="object"){const W=b(o[J]);if(W)return W}return null};r=b(s)}r?(console.log("Redirecionando para pÃ¡gina de sucesso com appointmentId:",r),y(`/client/booking-success?appointmentId=${r}`)):(console.error("Erro: ID do agendamento nÃ£o encontrado na resposta",s),p({title:"Erro de redirecionamento",description:"NÃ£o foi possÃ­vel acessar os detalhes do agendamento.",variant:"destructive"}),y("/client/appointments"))},onError:s=>{console.error("Erro ao criar agendamento:",s),p({title:"Erro ao agendar",description:s.message,variant:"destructive"})}});m.useEffect(()=>{if(f)console.log("UsuÃ¡rio autenticado, ID:",f.id,"Tipo:",f.userType||"nÃ£o especificado");else{console.log("UsuÃ¡rio nÃ£o estÃ¡ autenticado. Redirecionando para tela de login.");const s={providerId:c,serviceId:j,date:u,startTime:h,endTime:x,availabilityId:A};console.log("Salvando dados do agendamento para recuperaÃ§Ã£o pÃ³s-login:",s),sessionStorage.setItem("pendingBooking",JSON.stringify(s)),p({title:"AutenticaÃ§Ã£o necessÃ¡ria",description:"Ã‰ necessÃ¡rio estar logado para confirmar o agendamento. Redirecionando para o login...",variant:"default"}),setTimeout(()=>{y("/auth?redirect=booking")},1500)}},[f,c,j,u,h,x,A,y,p]);const de=async()=>{if(!f){p({title:"UsuÃ¡rio nÃ£o autenticado",description:"VocÃª precisa estar logado para agendar.",variant:"destructive"}),sessionStorage.setItem("pendingBooking",JSON.stringify({providerId:c,serviceId:j,date:u,startTime:h,endTime:x,availabilityId:A})),y("/auth?redirect=booking");return}if(!i||!t){p({title:"Erro ao confirmar",description:"Dados incompletos para o agendamento.",variant:"destructive"});return}const s=N==null?void 0:N.find(o=>o.id===v);if((s==null?void 0:s.processor)==="asaas"&&(s==null?void 0:s.type)==="online")try{p({title:"Processando pagamento...",description:"Aguarde enquanto processamos seu pagamento."});const o=await ye({customerId:f.id.toString(),providerId:c,serviceValue:t.price/100,billingType:v.includes("pix")?"PIX":"CREDIT_CARD",description:`Agendamento - ${t.name} com ${i.name||i.email}`,dueDate:u});if(o.success)p({title:"Pagamento processado!",description:"Pagamento realizado com sucesso. Criando agendamento..."});else throw new Error(o.message||"Erro ao processar pagamento")}catch(o){console.error("Erro no pagamento Asaas:",o),p({title:"Erro no pagamento",description:o.message||"NÃ£o foi possÃ­vel processar o pagamento. Tente novamente.",variant:"destructive"});return}const b={clientId:f.id,providerId:c,serviceId:j,date:u,startTime:h,endTime:x,notes:V,paymentMethod:v,availabilityId:A,discount:F?C:0};console.log("Dados do agendamento:",b),z.mutate(b)},me=()=>{if(!i||!t)return;const s=`
      Agendei um serviÃ§o no AgendoAI!
      
      ðŸ“ ServiÃ§o: ${t.name}
      ðŸ‘¤ Prestador: ${i.name||i.email}
      ðŸ“… Data: ${_}
      ðŸ•’ HorÃ¡rio: ${h} - ${x}
      
      Baixe o AgendoAI e agende tambÃ©m!
      https://agendoai.com
    `;Te(s)},d=m.useMemo(()=>{if(!N||!l)return console.log("MÃ©todos de pagamento nÃ£o disponÃ­veis ainda"),[];console.log("Filtrando mÃ©todos de pagamento:",{availablePaymentMethods:N,providerPaymentMethods:l});const s=N.filter(r=>r.type==="offline"?!(r.id==="money"&&!l.acceptsCash||r.id==="card_local"&&!l.acceptsDebitCard&&!l.acceptsCreditCard||r.id==="pix_local"&&!l.acceptsPix||r.id==="transfer"&&!l.acceptsTransfer):r.type==="online"?r.processor==="stripe"&&!l.preferStripe?(console.log("MÃ©todo stripe rejeitado porque prestador nÃ£o prefere Stripe"),!1):r.processor==="asaas"&&!l.preferAsaas?(console.log("MÃ©todo asaas rejeitado porque prestador nÃ£o prefere Asaas"),!1):r.id.includes("card")&&!l.acceptsCreditCard?(console.log("MÃ©todo cartÃ£o rejeitado porque prestador nÃ£o aceita cartÃ£o de crÃ©dito"),!1):r.id.includes("pix")&&!l.acceptsPix?(console.log("MÃ©todo pix rejeitado porque prestador nÃ£o aceita PIX"),!1):!0:!0);return console.log("MÃ©todos filtrados:",s),s},[N,l]);m.useEffect(()=>{v?(d==null?void 0:d.length)>0&&!d.some(s=>s.id===v)&&T(d[0].id):T("money")},[d,v]);const D=ce||le||z.isPending||Q||ie;return e.jsxs("div",{className:"min-h-screen bg-white",children:[e.jsx(_e,{}),e.jsxs("main",{className:"container px-4 py-8",children:[e.jsxs(g,{variant:"ghost",size:"sm",className:"mb-4",onClick:()=>window.history.back(),children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Voltar"]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Confirmar Agendamento"}),e.jsx("p",{className:"text-muted-foreground",children:"Verifique os detalhes e confirme seu agendamento"})]}),e.jsxs(M,{className:"mb-6",children:[e.jsx(k,{children:e.jsx(L,{children:"Detalhes do Agendamento"})}),e.jsx(R,{className:"space-y-4",children:D?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx($,{className:"h-6 w-6 animate-spin text-primary"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(ze,{className:"h-5 w-5 text-muted-foreground mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:(i==null?void 0:i.name)||(i==null?void 0:i.email)||"Prestador"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:(t==null?void 0:t.name)||"ServiÃ§o"})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(De,{className:"h-5 w-5 text-muted-foreground"}),e.jsx("p",{children:_})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx($e,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("p",{children:[h," - ",x]})]}),e.jsx(U,{}),e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("p",{children:"Total"}),e.jsx("p",{children:t?new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t.price/100):"Carregando..."})]})]})})]}),e.jsxs(M,{className:"mb-6",children:[e.jsx(k,{children:e.jsx(L,{children:"Forma de Pagamento"})}),e.jsx(R,{children:Q?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx($,{className:"h-6 w-6 animate-spin text-primary"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between mb-4",children:[e.jsxs(g,{variant:S==="offline"?"default":"outline",size:"sm",className:"flex-1 mr-2",onClick:()=>K("offline"),disabled:!d.some(s=>s.type==="offline"),children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"No local"]}),e.jsxs(g,{variant:S==="online"?"default":"outline",size:"sm",className:"flex-1 ml-2",onClick:()=>K("online"),disabled:!d.some(s=>s.type==="online"),children:[e.jsx(O,{className:"h-4 w-4 mr-2"}),"Online"]})]}),e.jsx(U,{className:"my-4"}),e.jsxs(be,{value:v,onValueChange:T,className:"space-y-3",children:[S==="offline"?d.filter(s=>s.type==="offline").map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(X,{value:s.id,id:s.id}),e.jsxs(q,{htmlFor:s.id,className:"flex items-center",children:[s.id==="money"?e.jsx(ee,{className:"h-4 w-4 mr-2 text-muted-foreground"}):s.id==="pix_local"?e.jsx(se,{className:"h-4 w-4 mr-2 text-muted-foreground"}):e.jsx(O,{className:"h-4 w-4 mr-2 text-muted-foreground"}),s.name]})]},s.id)):d.filter(s=>s.type==="online").map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(X,{value:s.id,id:s.id}),e.jsxs(q,{htmlFor:s.id,className:"flex items-center",children:[s.id.includes("pix")?e.jsx(se,{className:"h-4 w-4 mr-2 text-muted-foreground"}):e.jsx(O,{className:"h-4 w-4 mr-2 text-muted-foreground"}),s.name,s.processor&&e.jsx("span",{className:"ml-2 text-xs bg-muted text-muted-foreground px-2 py-0.5 rounded-full",children:s.processor==="stripe"?"Stripe":"Asaas"})]})]},s.id)),S==="offline"&&!d.some(s=>s.type==="offline")&&e.jsx("div",{className:"text-center p-4 border border-dashed rounded-md",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Este prestador nÃ£o aceita pagamentos no local."})}),S==="online"&&!d.some(s=>s.type==="online")&&e.jsx("div",{className:"text-center p-4 border border-dashed rounded-md",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Pagamentos online nÃ£o estÃ£o disponÃ­veis para este prestador."})})]})]})})]}),f&&f.userType==="provider"&&e.jsxs(M,{className:"mb-6",children:[e.jsxs(k,{children:[e.jsxs(L,{className:"flex items-center",children:[e.jsx(Ue,{className:"h-5 w-5 mr-2 text-primary"}),"Aplicar Desconto"]}),e.jsx(he,{children:"Conceda um desconto especial para este cliente"})]}),e.jsx(R,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(q,{htmlFor:"apply-discount",className:"flex items-center cursor-pointer",children:[e.jsx(Qe,{className:"h-4 w-4 mr-2 text-muted-foreground"}),"Ativar desconto"]}),e.jsx(Ce,{id:"apply-discount",checked:F,onCheckedChange:oe})]}),F&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(q,{htmlFor:"discount-slider",children:"Percentual de desconto"}),e.jsxs("span",{className:"font-medium text-primary",children:[C,"%"]})]}),e.jsx(we,{id:"discount-slider",value:[C],min:0,max:30,step:1,onValueChange:([s])=>ne(s),className:"py-4"}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[e.jsx("span",{children:"0%"}),e.jsx("span",{children:"15%"}),e.jsx("span",{children:"30%"})]})]}),(t==null?void 0:t.price)&&e.jsxs("div",{className:"bg-muted/50 p-4 rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"PreÃ§o original:"}),e.jsx("span",{children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t.price/100)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Desconto (",C,"%):"]}),e.jsxs("span",{className:"text-green-600",children:["- ",new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t.price*C/100/100)]})]}),e.jsx(U,{className:"my-2"}),e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("span",{children:"PreÃ§o final:"}),e.jsx("span",{className:"text-primary",children:new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format((t.price-t.price*C/100)/100)})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"O desconto Ã© aplicado apenas sobre o valor do serviÃ§o, a taxa da plataforma permanece a mesma."})]})]})]})})]}),e.jsxs(M,{className:"mb-6",children:[e.jsx(k,{children:e.jsx(L,{children:"ObservaÃ§Ãµes"})}),e.jsx(R,{children:e.jsx(Ne,{placeholder:"Adicione informaÃ§Ãµes importantes para o prestador (opcional)",value:V,onChange:s=>te(s.target.value),className:"resize-none",rows:3})})]}),e.jsxs("div",{className:"flex flex-col space-y-3",children:[e.jsxs(g,{onClick:de,disabled:D,className:"w-full",size:"lg",children:[z.isPending&&e.jsx($,{className:"mr-2 h-4 w-4 animate-spin"}),"Confirmar Agendamento"]}),e.jsxs(g,{variant:"outline",className:"w-full",onClick:me,disabled:D||!i||!t,children:[e.jsx(Oe,{className:"mr-2 h-4 w-4"}),"Compartilhar no WhatsApp"]})]})]})]})}export{Bs as default};
