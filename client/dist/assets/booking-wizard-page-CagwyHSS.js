import{r as i,d as P,j as e,C as $,y as Q,o as B,i as q,a as fe,H as ve,O as ge}from"./index-DOe1OCu1.js";import{C as je}from"./client-layout-CdnMDSOG.js";import{A as Ne,a as ye,b as we}from"./avatar-DkIWG9bC.js";import{B as z}from"./button-C168b4m4.js";import{S as A}from"./skeleton-B-0dSqkR.js";import{C as Se}from"./calendar-pyrfYCI4.js";import{A as M,a as R}from"./alert-D_O4txuz.js";import{C as be}from"./chevron-left-DXLkf5Yb.js";import{I as V}from"./info-B0VxSgSE.js";import{M as Ie}from"./map-pin-Z18Glv-N.js";import{S as Ce}from"./star-BMu2mbzX.js";import{C as W}from"./clock-CVsS3BCD.js";import{C as G}from"./chevron-right-D4BSFwhT.js";import{a as ke}from"./addDays-BQ37Zmqx.js";import{f as k}from"./format-CGvBu07F.js";import{p as T}from"./pt-BR-Cxqo7XV3.js";import"./navbar-DlESdVVP.js";import"./proxy-Ct5X7xz4.js";import"./house-Calz6FJi.js";import"./search-Bjz8DxPP.js";import"./calendar-check-CY2XiYKN.js";import"./user-BQOYdOBU.js";import"./en-US-xSPtgCq_.js";import"./endOfMonth-CH6FLORf.js";import"./isSameDay-BJjwZdUf.js";import"./subDays-K6OA95hK.js";function Ee(u,m,n=30){const[v,N]=i.useState({}),[x,t]=i.useState(!1),[r,h]=i.useState(null);return i.useEffect(()=>{if(!u||!m)return;t(!0),h(null);const c=new Date;(async()=>{const g={};for(let l=0;l<n;l++){const F=ke(c,l),p=k(F,"yyyy-MM-dd");try{const j=await fetch(`/api/providers/${u}/availability?date=${p}&duration=${m.duration}`);if(j.ok){const C=await j.json();Array.isArray(C)&&C.length>0&&(g[p]=C)}}catch{h("Erro ao buscar horários disponíveis")}}N(g),t(!1)})()},[u,m,n]),{slotsByDate:v,isLoading:x,error:r}}function De({onComplete:u}){const[m,n]=i.useState("niche"),[v,N]=i.useState(null),[x,t]=i.useState(null),[r,h]=i.useState(null),[c,w]=i.useState(null),[g,l]=i.useState(null),[F,p]=i.useState(null);i.useEffect(()=>{const s=new URLSearchParams(window.location.search),a=s.get("providerId"),o=s.get("serviceId");a&&o?(n("providers"),(async()=>{try{const d=parseInt(a),y=parseInt(o),b=await fetch(`/api/providers/${d}`);if(b.ok){const I=await b.json();l(I)}const K=await fetch(`/api/services/${y}`);if(K.ok){const I=await K.json(),_=await fetch(`/api/service-templates?categoryId=${I.categoryId}`);if(_.ok){const O=(await _.json()).find(L=>L.name.toLowerCase().includes(I.name.toLowerCase()));if(O){h(O),t(I.categoryId);const L=await fetch(`/api/categories/${I.categoryId}`);if(L.ok){const pe=await L.json();N(pe.nicheId)}}}}}catch(d){console.error("Erro ao carregar dados pré-selecionados:",d)}})()):a&&(n("providers"),(async()=>{try{const d=parseInt(a),y=await fetch(`/api/providers/${d}`);if(y.ok){const b=await y.json();l(b)}}catch(d){console.error("Erro ao carregar dados do prestador:",d)}})())},[]);const{data:j,isLoading:C}=P({queryKey:["/api/niches"]}),{data:E,isLoading:J}=P({queryKey:["/api/niches",v,"categories"],queryFn:async()=>{if(!v)return[];const s=await fetch(`/api/niches/${v}/categories`);if(!s.ok)throw new Error("Falha ao carregar categorias");return s.json()},enabled:!!v}),{data:D,isLoading:X}=P({queryKey:["/api/service-templates",x],queryFn:async()=>{if(!x)return[];const s=await fetch(`/api/service-templates?categoryId=${x}`);if(!s.ok)throw new Error("Falha ao carregar serviços");return s.json()},enabled:!!x}),{data:S,isLoading:Y}=P({queryKey:["/api/providers/search",r==null?void 0:r.id,c],queryFn:async()=>{if(!r||!x)return[];let s=`/api/providers/search?categoryId=${x}&executionTime=${r.duration}`;if(c){const f=k(c,"yyyy-MM-dd");s+=`&date=${f}`}const a=await fetch(s);if(!a.ok)throw new Error("Falha ao carregar prestadores disponíveis");return(await a.json()).filter(f=>f.services.some(d=>d.name.includes(r.name)))},enabled:!!r&&!!x}),{slotsByDate:U,isLoading:Z,error:H}=Ee((g==null?void 0:g.id)??null,r,30),ee=s=>{N(s),n("category"),t(null),h(null),w(null),l(null),p(null)},se=s=>{t(s),n("service"),h(null),w(null),l(null),p(null)},re=s=>{h(s),n("date"),w(null),l(null),p(null)},ae=s=>{w(s),s&&(n("providers"),l(null),p(null))},te=s=>{l(s),n("slots"),p(null)},ne=s=>{if(p(s),g&&r&&s.date&&u){const a=g.services.find(o=>o.name.includes(r.name));a&&u({serviceId:a.id,providerId:g.id,date:s.date,startTime:s.startTime,endTime:s.endTime})}},ie=()=>{switch(m){case"category":n("niche"),t(null);break;case"service":n("category"),h(null);break;case"date":n("service"),w(null);break;case"providers":n("date"),l(null),p(null);break}},oe=()=>{switch(m){case"niche":return"Escolha uma Área de Serviço";case"category":return"Escolha uma Categoria";case"service":return"Qual serviço você precisa?";case"date":return"Selecione uma Data";case"providers":return"Prestadores Disponíveis";case"slots":return"Escolha um Horário";default:return""}},ce=()=>C?e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[...Array(6)].map((s,a)=>e.jsx(A,{className:"h-32 rounded-lg"},a))}):j!=null&&j.length?e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:j.map(s=>e.jsx($,{className:"cursor-pointer border-2 hover:border-primary hover:bg-primary/5 transition-colors",onClick:()=>ee(s.id),children:e.jsxs(q,{className:"flex flex-col items-center justify-center p-4 text-center h-full",children:[s.icon&&e.jsx("div",{className:"text-4xl mb-3",children:s.icon}),e.jsx("h3",{className:"font-medium text-lg",children:s.name}),s.description&&e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:s.description})]})},s.id))}):e.jsxs(M,{variant:"destructive",className:"mb-4",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsx(R,{children:"Não foi possível carregar as áreas de serviço. Por favor, tente novamente mais tarde."})]}),le=()=>J?e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[...Array(6)].map((s,a)=>e.jsx(A,{className:"h-32 rounded-lg"},a))}):E!=null&&E.length?e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:E.map(s=>e.jsx($,{className:"cursor-pointer border-2 hover:border-primary hover:bg-primary/5 transition-colors",onClick:()=>se(s.id),children:e.jsxs(q,{className:"flex flex-col items-center justify-center p-4 text-center h-full",children:[s.icon&&e.jsx("div",{className:"text-4xl mb-3",children:s.icon}),e.jsx("h3",{className:"font-medium text-lg",children:s.name}),s.description&&e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:s.description})]})},s.id))}):e.jsxs(M,{variant:"destructive",className:"mb-4",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsx(R,{children:"Não foi possível encontrar categorias para esta área. Por favor, selecione outra área de serviço."})]}),de=()=>X?e.jsx("div",{className:"space-y-4",children:[...Array(5)].map((s,a)=>e.jsx(A,{className:"h-24 rounded-lg"},a))}):D!=null&&D.length?e.jsx("div",{className:"space-y-3",children:D.map(s=>e.jsx($,{className:"cursor-pointer hover:bg-primary/5 transition-colors",onClick:()=>re(s),children:e.jsx(q,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:s.name}),s.description&&e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:s.description}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 mt-2",children:[e.jsxs("div",{className:"flex items-center text-muted-foreground",children:[e.jsx(W,{className:"h-4 w-4 mr-1"}),e.jsxs("span",{className:"text-sm",children:[s.duration," min"]})]}),s.price!==null&&e.jsx("div",{className:"font-medium",children:Q(s.price)})]})]}),e.jsx(G,{className:"h-5 w-5 text-muted-foreground"})]})})},s.id))}):e.jsxs(M,{variant:"destructive",className:"mb-4",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsx(R,{children:"Não foi possível encontrar serviços para esta categoria. Por favor, selecione outra categoria."})]}),me=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Selecione uma data para o agendamento"}),e.jsx("p",{className:"text-muted-foreground",children:"Escolha a data em que você deseja receber o serviço."})]}),e.jsxs("div",{className:"border rounded-lg p-4 flex flex-col items-center",children:[e.jsx(Se,{mode:"single",selected:c,onSelect:ae,disabled:s=>s<new Date(new Date().setHours(0,0,0,0)),locale:T,className:"mx-auto"}),c&&e.jsx("div",{className:"mt-4 w-full",children:e.jsxs(M,{children:[e.jsx(V,{className:"h-4 w-4"}),e.jsxs(R,{children:["Você selecionou: ",e.jsx("span",{className:"font-medium",children:k(c,"EEEE, d 'de' MMMM 'de' yyyy",{locale:T})})]})]})})]})]}),xe=()=>Y?e.jsx("div",{className:"space-y-4",children:[...Array(3)].map((s,a)=>e.jsx(A,{className:"h-36 rounded-lg"},a))}):S!=null&&S.length?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Prestadores Disponíveis"}),e.jsx("p",{className:"text-muted-foreground",children:S.length===1?"Encontramos 1 prestador disponível para você.":`Encontramos ${S.length} prestadores disponíveis para você.`})]}),e.jsx("div",{className:"space-y-4",children:S.map(s=>{var o,f,d,y;const a=s.services.find(b=>r&&b.name.includes(r.name));return e.jsx($,{className:"overflow-hidden cursor-pointer hover:shadow-md transition-shadow",onClick:()=>te(s),children:e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsxs(Ne,{className:"h-16 w-16 rounded-lg mr-4 flex-shrink-0",children:[e.jsx(ye,{src:s.profileImage||void 0}),e.jsx(we,{className:"rounded-lg bg-primary/10 text-xl",children:((o=s.name)==null?void 0:o.charAt(0))||"P"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-bold truncate",children:((f=s.settings)==null?void 0:f.businessName)||s.name||"Prestador"}),((d=s.settings)==null?void 0:d.address)&&e.jsxs("div",{className:"flex items-center text-muted-foreground mb-1",children:[e.jsx(Ie,{className:"h-3.5 w-3.5 mr-1 flex-shrink-0"}),e.jsx("span",{className:"text-xs truncate",children:s.settings.address})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-3 gap-y-1 mt-1",children:[((y=s.settings)==null?void 0:y.rating)&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(Ce,{className:"h-4 w-4 text-amber-500 mr-1 flex-shrink-0"}),e.jsx("span",{className:"text-sm font-medium",children:s.settings.rating.toFixed(1)})]}),a&&e.jsx("div",{className:"flex items-center text-primary",children:e.jsx("span",{className:"text-sm font-semibold",children:Q(a.price||0)})}),s.distance!==void 0&&e.jsx("div",{className:"flex items-center text-muted-foreground",children:e.jsx("span",{className:"text-xs",children:s.distance<1?`${(s.distance*1e3).toFixed(0)}m`:`${s.distance.toFixed(1)}km`})}),e.jsxs("div",{className:"flex items-center text-muted-foreground",children:[e.jsx(W,{className:"h-3.5 w-3.5 mr-1 flex-shrink-0"}),e.jsxs("span",{className:"text-xs",children:[s.executionTimeForService||(a==null?void 0:a.duration)||(r==null?void 0:r.duration)," min"]})]})]})]}),e.jsx(G,{className:"h-5 w-5 text-muted-foreground ml-2 self-center"})]})})},s.id)})})]}):e.jsxs("div",{className:"text-center space-y-4 py-6",children:[e.jsx("div",{className:"text-amber-500 mx-auto h-12 w-12 rounded-full bg-amber-100 flex items-center justify-center",children:e.jsx(V,{className:"h-6 w-6"})}),e.jsx("h3",{className:"text-lg font-medium",children:"Nenhum prestador disponível"}),e.jsx("p",{className:"text-muted-foreground max-w-md mx-auto",children:c?`Não encontramos prestadores disponíveis para ${k(c,"d 'de' MMMM",{locale:T})} para este serviço.`:"Não encontramos prestadores disponíveis para este serviço com as opções selecionadas."}),e.jsx("div",{className:"pt-2 space-y-2",children:e.jsx(z,{variant:"outline",onClick:()=>n("date"),children:"Escolher outra data"})})]}),ue=()=>{if(Z)return e.jsx("div",{className:"p-6 text-center",children:"Carregando horários disponíveis..."});if(H)return e.jsx("div",{className:"p-6 text-center text-red-500",children:H});const s=Object.keys(U);return s.length===0?e.jsx("div",{className:"p-6 text-center text-neutral-500",children:"Nenhum horário disponível nos próximos 30 dias."}):e.jsxs("div",{className:"p-4",children:[e.jsx("h3",{className:"font-bold mb-4",children:"Escolha um horário disponível"}),s.map(a=>e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"font-semibold text-primary mb-2",children:k(new Date(a),"EEEE, dd/MM/yyyy",{locale:T})}),e.jsx("div",{className:"flex flex-wrap gap-2",children:U[a].map((o,f)=>e.jsxs(z,{variant:F===o?"default":"outline",onClick:()=>ne({...o,date:a}),children:[o.startTime," - ",o.endTime]},f))})]},a))]})},he=()=>{switch(m){case"niche":return ce();case"category":return le();case"service":return de();case"date":return me();case"providers":return xe();case"slots":return ue();default:return null}};return e.jsxs("div",{className:"pb-20",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:oe()}),m==="providers"&&r&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:[r.name," - ",r.duration," minutos"]})]}),m!=="niche"&&e.jsxs(z,{variant:"ghost",size:"sm",onClick:ie,className:"flex items-center",children:[e.jsx(be,{className:"h-4 w-4 mr-1"}),"Voltar"]})]}),e.jsx("div",{children:he()})]})}function as(){const[,u]=fe(),[m,n]=i.useState(!1),[v,N]=i.useState({hasError:!1}),x=async t=>{try{if(n(!0),N({hasError:!1}),!t.providerId||!t.serviceId)throw new Error("Dados de agendamento incompletos");if(t.date&&t.startTime&&t.endTime){const r=encodeURIComponent(t.date),h=encodeURIComponent(t.startTime),c=encodeURIComponent(t.endTime);u(`/client/booking-confirmation/${t.providerId}/${t.serviceId}/${r}/${h}/${c}`)}else{const r=new URLSearchParams;r.append("providerId",t.providerId.toString()),r.append("serviceId",t.serviceId.toString()),u(`/client/booking-wizard?${r.toString()}`)}}catch(r){N({hasError:!0,message:r instanceof Error?r.message:"Ocorreu um erro inesperado"}),u("/client/booking-wizard")}finally{n(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(ve,{children:[e.jsx("title",{children:"Agendar Serviço | AgendoAI"}),e.jsx("meta",{name:"description",content:"Agende seu serviço personalizado com nossos profissionais qualificados"})]}),e.jsx(je,{children:e.jsxs("div",{className:"container mx-auto py-6 px-4 sm:px-6 lg:px-8 max-w-3xl",children:[v.hasError?e.jsx("div",{className:"bg-red-50 border-l-4 border-red-500 p-4 mb-6",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-red-500",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),e.jsx("div",{className:"ml-3",children:e.jsx("p",{className:"text-sm text-red-700",children:v.message||"Erro ao processar seu agendamento. Tente novamente."})})]})}):null,m?e.jsxs("div",{className:"flex flex-col items-center justify-center h-64",children:[e.jsx(ge,{className:"h-12 w-12 text-primary"}),e.jsx("p",{className:"mt-4 text-gray-600",children:"Processando seu agendamento..."})]}):e.jsx(De,{onComplete:x,initialData:{serviceId:null,providerId:null,date:null,startTime:null,endTime:null}})]})})]})}export{as as default};
