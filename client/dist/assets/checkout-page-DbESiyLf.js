import{r as a,c as B,a as V,j as e,C as v,f as w,g as P,h as L,i as b,o as C,k as T,l as _}from"./index-DlYle-HK.js";import{l as z}from"./index-C8r34K29.js";import{E as D,u as Y,a as q,P as $,A as G}from"./react-stripe.esm-WwQILy7A.js";import{B as y}from"./button-0YWTsIWD.js";import{S as H}from"./separator-DFxxhpCE.js";import{P as M}from"./progress-CxwTZ0K1.js";import{A as S,b as E,a as I}from"./alert-Byp0y-1Q.js";import{C as O}from"./credit-card-U98LyAvR.js";import"./index-D4KYuKUS.js";const U=z("pk_test_51RkqXrRr6s3UmWYUrWgAlgej5ir5MpLUjjpQLkGPeHeg8vy3ZJAbIttYkjR3EzrI9zzvFgI6lPRMZhGj55NnIFYF00F1YurTA7"),Q=({amount:f,description:d})=>{const i=Y(),p=q(),[r,x]=a.useState(!1),[j,n]=a.useState(null),[g,N]=a.useState(!1),{toast:c}=B(),o=async l=>{if(l.preventDefault(),!(!i||!p)){x(!0),n(null);try{const{error:s}=await i.confirmPayment({elements:p,confirmParams:{return_url:`${window.location.origin}/payment-success`,payment_method_data:{billing_details:{address:{country:"BR"}}}}});s&&(n(s.message||"Ocorreu um erro ao processar o pagamento."),c({title:"Falha no pagamento",description:s.message||"Ocorreu um erro ao processar o pagamento.",variant:"destructive"}))}catch(s){n(s.message||"Ocorreu um erro inesperado."),c({title:"Erro no pagamento",description:s.message||"Ocorreu um erro inesperado.",variant:"destructive"})}finally{x(!1)}}};return e.jsxs("form",{onSubmit:o,className:"space-y-6",children:[j&&e.jsxs(S,{variant:"destructive",className:"mb-4",children:[e.jsx(C,{className:"h-4 w-4"}),e.jsx(E,{children:"Erro no pagamento"}),e.jsx(I,{children:j})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700",children:"Informações do cartão"}),e.jsx($,{onChange:l=>N(l.complete),options:{layout:{type:"tabs",defaultCollapsed:!1}}})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700",children:"Endereço de cobrança"}),e.jsx(G,{options:{mode:"billing",fields:{phone:"always"},validation:{phone:{required:"always"}},defaultValues:{address:{country:"BR"}}}})]}),e.jsxs("div",{className:"pt-4",children:[e.jsx(y,{type:"submit",className:"w-full flex items-center justify-center gap-2",disabled:!i||r||!g,children:r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Processando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"h-4 w-4"}),e.jsxs("span",{children:["Pagar R$ ",(f/100).toFixed(2)]})]})}),e.jsxs("p",{className:"text-xs text-center text-gray-500 mt-4",children:["Pagamento processado de forma segura pelo Stripe.",d&&e.jsx("span",{className:"block mt-1",children:d})]})]})]})},ne=()=>{const[f,d]=a.useState(null),[i,p]=a.useState(0),[r,x]=a.useState(),[j,n]=a.useState(!0),[g,N]=a.useState(null),[c,o]=a.useState(10),{toast:l}=B();V();const s=new URLSearchParams(window.location.search),u=s.get("appointmentId"),R=s.get("serviceId"),m=s.get("amount"),h=s.get("description"),k=s.get("clientSecret");return a.useEffect(()=>{(async()=>{if(k){d(k);const t=m?parseInt(m,10):0;p(t),h&&x(decodeURIComponent(h)),n(!1);return}if(!u&&!m){N("Informações de pagamento incompletas na URL"),n(!1);return}try{o(30);const t=m?parseInt(m,10):0;p(t),h&&x(decodeURIComponent(h)),o(50);const F=await _("POST","/api/payments/create-payment-intent",{amount:t/100,description:r,metadata:{appointmentId:u||"none",serviceId:R||"none"}});o(70);const A=await F.json();if(!F.ok)throw new Error(A.message||"Erro ao criar sessão de pagamento");o(90),d(A.clientSecret)}catch(t){console.error("Erro ao inicializar pagamento:",t),N(t.message||"Não foi possível iniciar o pagamento"),l({title:"Erro",description:t.message||"Não foi possível iniciar o pagamento",variant:"destructive"})}finally{o(100),n(!1)}})()},[u,R,m,h,l]),j?e.jsxs("div",{className:"container max-w-md mx-auto flex flex-col items-center justify-center h-screen p-4",children:[e.jsx("h2",{className:"text-xl font-medium mb-6",children:"Preparando Pagamento"}),e.jsx(M,{value:c,className:"w-full mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:c<50?"Carregando informações de pagamento...":c<90?"Conectando com o gateway de pagamento...":"Quase pronto..."})]}):g?e.jsx("div",{className:"container max-w-md mx-auto p-4",children:e.jsxs(v,{children:[e.jsxs(w,{children:[e.jsx(P,{className:"text-center text-red-500",children:"Erro no Pagamento"}),e.jsx(L,{className:"text-center",children:"Não foi possível iniciar o processo de pagamento"})]}),e.jsx(b,{children:e.jsxs(S,{variant:"destructive",className:"mb-4",children:[e.jsx(C,{className:"h-4 w-4"}),e.jsx(E,{children:"Falha ao conectar"}),e.jsx(I,{children:g})]})}),e.jsxs(T,{className:"flex flex-col gap-2",children:[e.jsx(y,{onClick:()=>window.history.back(),className:"w-full",children:"Voltar"}),e.jsx(y,{variant:"outline",onClick:()=>window.location.reload(),className:"w-full",children:"Tentar novamente"})]})]})}):U?e.jsx("div",{className:"container max-w-md mx-auto p-4",children:e.jsxs(v,{className:"border-primary/10",children:[e.jsxs(w,{className:"pb-4",children:[e.jsxs(P,{className:"text-center flex items-center justify-center gap-2",children:[e.jsx(O,{className:"h-5 w-5 text-primary"}),e.jsx("span",{children:"Finalizar Pagamento"})]}),e.jsx(L,{className:"text-center",children:"Preencha os dados para concluir seu pagamento"})]}),e.jsxs(b,{children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex flex-col gap-2 p-4 bg-primary/5 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm",children:"Valor a pagar:"}),e.jsxs("span",{className:"font-semibold text-lg",children:["R$ ",(i/100).toFixed(2)]})]}),r&&e.jsx("div",{className:"text-sm text-gray-600",children:r}),u&&e.jsxs("div",{className:"text-xs text-gray-500 mt-2",children:["Reserva #",u]})]}),e.jsx(H,{className:"my-6"})]}),f&&e.jsx(D,{stripe:U,options:{clientSecret:f,appearance:{theme:"stripe",variables:{colorPrimary:"#6366f1",colorBackground:"#ffffff",colorText:"#1f2937"}},locale:"pt-BR"},children:e.jsx(Q,{amount:i,description:r})})]})]})}):e.jsx("div",{className:"container max-w-md mx-auto p-4",children:e.jsxs(v,{children:[e.jsx(w,{children:e.jsx(P,{className:"text-center text-red-500",children:"Configuração Incompleta"})}),e.jsx(b,{children:e.jsxs(S,{variant:"destructive",className:"mb-4",children:[e.jsx(C,{className:"h-4 w-4"}),e.jsx(E,{children:"Serviço indisponível"}),e.jsx(I,{children:"O sistema de pagamentos está temporariamente indisponível. Por favor, tente novamente mais tarde ou entre em contato com o suporte."})]})}),e.jsx(T,{children:e.jsx(y,{onClick:()=>window.history.back(),className:"w-full",children:"Voltar"})})]})})};export{ne as default};
