import{s as U,a as Y,u as Z,c as ee,r as o,v as ae,w,j as e,e as T,C as X,f as L,g as A,i as q}from"./index-BdrEJuYD.js";import{B as g}from"./button-CynjWJoH.js";import{B as R}from"./badge-muy4ZFs4.js";import{A as te}from"./arrow-left-nRi6-7bo.js";import{Q as b}from"./qr-code-B85NaMFy.js";import{C as se}from"./circle-check-big-CiI_Z36v.js";import{C as ne}from"./copy-Dcp0QFic.js";import{C as re}from"./credit-card-dV_1iaRW.js";import{f as oe}from"./format-CGvBu07F.js";import{p as ie}from"./pt-BR-Cxqo7XV3.js";import"./en-US-xSPtgCq_.js";function Ce(){const{appointmentId:x}=U(),[,p]=Y(),{user:c}=Z(),{toast:l}=ee(),[s,C]=o.useState(null),[I,F]=o.useState(null),[m,O]=o.useState(null),[J,f]=o.useState(!0),[j,u]=o.useState(!1),[v,d]=o.useState("pending"),[ce,de]=o.useState(null),[Q,le]=o.useState(null),[D,h]=o.useState(!1),[N,P]=o.useState(null),[me,z]=o.useState(null),[y,S]=o.useState(null),[k,M]=o.useState(!1),[E]=ae();o.useEffect(()=>{if(x){(async()=>{f(!0);try{const a=await w(`/api/booking/${x}`);if(!a||!a.paymentId){l({title:"Agendamento não possui pagamento vinculado",description:"Entre em contato com o suporte.",variant:"destructive"}),f(!1);return}C({providerId:a.providerId,serviceId:a.serviceId,date:a.date,startTime:a.startTime,endTime:a.endTime,totalPrice:a.totalPrice,paymentMethod:a.paymentMethod||"pix"});const n=await w(`/api/asaas-marketplace/payments/${a.paymentId}/status`);n.status==="PENDING"||n.status==="pending"?(P(n.pixQrCode||n.qrCode||null),S(n.pixQrCodeImage||n.qrCodeImage||null),h(!0),d("pending")):n.status==="RECEIVED"||n.status==="paid"?(d("success"),h(!1)):(d("pending"),h(!1))}catch(a){l({title:"Erro ao buscar pagamento",description:a.message||"Tente novamente ou entre em contato com o suporte.",variant:"destructive"})}finally{f(!1)}})();return}if(!c){p("/auth?redirect=payment");return}const t=sessionStorage.getItem("pendingBookingData");if(t)try{const a=JSON.parse(t);C(a),_(a.providerId,a.serviceId);return}catch{}const i=parseFloat(E.get("amount")||"0"),r=E.get("paymentMethod")||"pix";if(i>0){C({providerId:0,serviceId:0,date:"",startTime:"",endTime:"",totalPrice:i,paymentMethod:r}),f(!1),r==="pix"&&(c!=null&&c.asaasCustomerId)&&(async()=>{u(!0);try{const n={amount:i,description:"Pagamento PIX - Valor direto",customerId:c.asaasCustomerId,metadata:{paymentMethod:"pix"}},$=await(await fetch("/api/payments/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).json();if($.paymentId){const B=await fetch(`/api/payments/pixQrCode/${$.paymentId}`);if(B.ok){const V=await B.json();P(V.pixQrCode),S(V.pixQrCodeImage),h(!0)}}}catch{l({title:"Erro ao gerar pagamento PIX",description:"Tente novamente ou entre em contato com o suporte.",variant:"destructive"})}finally{u(!1)}})();return}else l({title:"Dados não encontrados",description:"Por favor, inicie o agendamento novamente.",variant:"destructive"}),p("/")},[c,p,l,E,x]),o.useEffect(()=>{if(x&&v==="pending"){const t=setInterval(async()=>{try{const i=await w(`/api/booking/${x}`);if(i&&i.paymentId){const r=await w(`/api/asaas-marketplace/payments/${i.paymentId}/status`);(r.status==="RECEIVED"||r.status==="paid")&&(d("success"),h(!1),clearInterval(t))}}catch{}},5e3);return()=>clearInterval(t)}},[x,v]);const _=async(t,i)=>{try{const r=await fetch(`/api/providers/${t}`);if(r.ok){const n=await r.json();F(n)}const a=await fetch(`/api/services/${i}`);if(a.ok){const n=await a.json();O(n)}}catch(r){console.error("Erro ao buscar dados:",r)}finally{f(!1)}},G=async()=>{if(s){u(!0),d("processing");try{const t={amount:s.totalPrice,description:`Agendamento - ${(m==null?void 0:m.name)||"Serviço"} com ${(I==null?void 0:I.name)||"Prestador"}`,customerId:c==null?void 0:c.asaasCustomerId,metadata:{providerId:s.providerId,serviceId:s.serviceId,date:s.date,startTime:s.startTime,paymentMethod:s.paymentMethod,appointmentType:s.multipleServices?"consecutive":"single",duration:(m==null?void 0:m.duration)||30}};console.log("user:",c),console.log("Payload enviado:",t);const i=await fetch("/api/payments/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),r=await i.json();if(!i.ok)throw new Error(r.error||"Erro ao criar pagamento");if(s.paymentMethod==="pix"&&r.paymentId){try{const a=await fetch(`/api/payments/pixQrCode/${r.paymentId}`);if(a.ok){const n=await a.json();P(n.pixQrCode),S(n.pixQrCodeImage),h(!0)}}catch(a){console.error("Erro ao buscar QR Code do PIX:",a)}d("pending")}else(s.paymentMethod==="credit_card"||s.paymentMethod==="debit_card")&&r.paymentLink&&z(r.paymentLink),d("pending")}catch(t){d("failed"),l({title:"Erro no pagamento",description:t.message||"Tente novamente.",variant:"destructive"})}finally{u(!1)}}},H=()=>{p(-1)},W=async()=>{if(Q){u(!0);try{const t=await fetch(`/api/payments/check-status/${Q}`);if(!t.ok)throw new Error("Erro ao verificar status do pagamento");(await t.json()).status==="succeeded"?(d("success"),l({title:"Pagamento confirmado!",description:"Seu agendamento foi criado com sucesso."}),sessionStorage.removeItem("bookingData"),setTimeout(()=>{p("/client/payment-success")},2e3)):l({title:"Pagamento pendente",description:"O pagamento ainda não foi confirmado. Tente novamente em alguns segundos."})}catch(t){console.error("Erro ao verificar status:",t),l({title:"Erro",description:"Não foi possível verificar o status do pagamento.",variant:"destructive"})}finally{u(!1)}}},K=()=>{N&&(navigator.clipboard.writeText(N),M(!0),setTimeout(()=>M(!1),1500))};return J?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(T,{className:"h-8 w-8 animate-spin mx-auto mb-4"}),e.jsx("p",{children:"Carregando dados do pagamento..."})]})}):s?e.jsx("div",{className:"min-h-screen bg-gray-50 py-8",children:e.jsxs("div",{className:"max-w-md mx-auto",children:[e.jsxs(g,{variant:"ghost",onClick:()=>p("/client/new-booking-wizard"),className:"mb-4",children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Voltar"]}),D&&v==="pending"&&e.jsxs("div",{className:"mb-4",children:[e.jsx(R,{variant:"warning",className:"mb-2",children:"Aguardando pagamento"}),e.jsx("div",{className:"text-xs text-gray-600 mb-2",children:"Se você já pagou, aguarde a confirmação. Não tente pagar novamente."}),e.jsx("div",{className:"text-xs text-gray-500 mb-2",children:"A confirmação pode levar alguns minutos. Você pode fechar esta tela e acompanhar o status no dashboard."})]}),v==="success"&&e.jsxs("div",{className:"mb-4",children:[e.jsx(R,{variant:"success",className:"mb-2",children:"Pagamento confirmado!"}),e.jsx("div",{className:"text-xs text-green-700 mb-2",children:"Seu pagamento foi confirmado. Você pode voltar ao dashboard."})]}),D?e.jsxs(X,{className:"shadow-xl border-2 border-teal-100",children:[e.jsx(L,{children:e.jsxs(A,{className:"flex items-center gap-2 text-teal-700",children:[e.jsx(b,{className:"h-5 w-5"}),"Pagamento PIX"]})}),e.jsx(q,{className:"space-y-4",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-lg mb-4 flex flex-col items-center",children:[y?e.jsx("img",{src:y&&!y.startsWith("data:image")?`data:image/png;base64,${y}`:y,alt:"QR Code PIX",className:"mx-auto mb-2 rounded-lg border border-gray-200 shadow",style:{width:256,height:256}}):e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"h-32 w-32 mx-auto text-gray-400"}),e.jsx("p",{className:"text-sm text-gray-600 mt-2",children:"QR Code do PIX será exibido aqui"})]}),N&&e.jsxs("div",{className:"mt-4 w-full flex flex-col items-center",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Ou copie o código PIX:"}),e.jsxs("div",{className:"flex w-full items-center gap-2",children:[e.jsx("textarea",{value:N,readOnly:!0,className:"w-full text-xs bg-gray-100 p-2 rounded border border-gray-200 focus:outline-none focus:ring-2 focus:ring-teal-400 transition",rows:2,onClick:t=>t.target.select(),style:{resize:"none"}}),e.jsx(g,{type:"button",size:"icon",variant:k?"success":"outline",onClick:K,className:"ml-1","aria-label":"Copiar código PIX",children:k?e.jsx(se,{className:"h-5 w-5 text-green-600"}):e.jsx(ne,{className:"h-5 w-5"})})]}),k&&e.jsx("span",{className:"text-xs text-green-600 mt-1",children:"Copiado!"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-gray-700 font-medium",children:"Escaneie o QR Code com seu app bancário ou copie o código acima para pagar."}),e.jsxs("p",{className:"text-base text-gray-700",children:["Valor: ",e.jsxs("span",{className:"font-semibold text-teal-700",children:["R$ ",s.totalPrice.toFixed(2).replace(".",",")]})]})]}),e.jsx("div",{className:"mt-6",children:e.jsx(g,{onClick:()=>W(),disabled:j,className:"w-full h-12 text-lg bg-teal-600 hover:bg-teal-700 text-white shadow",children:j?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"h-4 w-4 mr-2 animate-spin"}),"Verificando pagamento..."]}):"Verificar pagamento"})})]})})]}):e.jsxs(X,{className:"shadow-xl border-2 border-teal-100 bg-white",children:[e.jsx(L,{children:e.jsxs(A,{className:"flex items-center gap-2 text-teal-700",children:[e.jsx(b,{className:"h-5 w-5"}),"Confirmar Pagamento"]})}),e.jsxs(q,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"font-semibold text-lg text-gray-800 flex items-center gap-2",children:[e.jsx(re,{className:"h-5 w-5 text-teal-500"}),"Resumo do Agendamento"]}),e.jsx("div",{className:"bg-gray-50 p-4 rounded-xl border border-gray-100 flex flex-col gap-2",children:m?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:m.name}),e.jsx("p",{className:"text-sm text-gray-600",children:oe(new Date(s.date),"EEEE, dd 'de' MMMM",{locale:ie})}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.startTime," - ",s.endTime]})]}),e.jsx(R,{variant:"secondary",children:s.paymentMethod==="pix"?"PIX":"Cartão"})]})}):e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-gray-700 font-medium",children:"Pagamento PIX direto"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Preencha o valor e clique em pagar"})]})}),e.jsx("div",{className:"border-t pt-3",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Total a pagar:"}),e.jsxs("span",{className:"text-2xl font-bold text-teal-700 drop-shadow",children:["R$ ",s.totalPrice.toFixed(2).replace(".",",")]})]})})]}),e.jsx(g,{onClick:G,disabled:j,className:"w-full h-14 text-lg bg-gradient-to-r from-teal-500 to-teal-700 hover:from-teal-600 hover:to-teal-800 text-white shadow-lg rounded-xl flex items-center justify-center gap-2 transition-all duration-150",children:j?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"h-5 w-5 mr-2 animate-spin"}),"Processando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"h-6 w-6 mr-2"}),e.jsx("span",{className:"font-semibold",children:"Pagar com PIX"})]})})]})]}),e.jsx(g,{variant:"outline",onClick:()=>p("/client/dashboard"),className:"mt-4 w-full",children:"Voltar ao Dashboard"})]})}):e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{children:"Dados do agendamento não encontrados."}),e.jsx(g,{onClick:H,className:"mt-4",children:"Voltar"})]})})}export{Ce as default};
