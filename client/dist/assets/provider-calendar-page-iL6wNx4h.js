import{j as e}from"./ui-UIpCtT3r.js";import{u as G,b as ee,a as te,c as _,i as u,C as ae,g as se,B as K,p as ie}from"./index-DMVSlINz.js";import{r}from"./vendor-vA4cx1mx.js";import{F as S,l as M,a as ne,b as A,i as R}from"./pt-br-BXicMjUb.js";import{T as re,a as oe,b as D,c as k}from"./tabs-BeATRqWY.js";import{I as O}from"./input-swbZ2nNg.js";import{u as I}from"./useMutation-mYWno7MC.js";import{u as le,t as de,o as ce,e as me,s as v}from"./zod-BPPSwYm9.js";import{f as d}from"./format-CGvBu07F.js";import"./router-CxXythJb.js";import"./en-US-xSPtgCq_.js";const ue=ce({title:v().min(1,"Título é obrigatório"),client_id:v().min(1,"Cliente é obrigatório"),service_id:v().min(1,"Serviço é obrigatório"),date:v().min(1,"Data é obrigatória"),start_time:v().min(1,"Horário de início é obrigatório"),end_time:v().optional(),notes:v().optional(),payment_method:me(["pix","cartao","dinheiro"]).default("pix")}),xe=()=>{var Q,F;const{user:i}=G(),{toast:o}=ee(),h=te(),[y,V]=r.useState([]),[pe,P]=r.useState(null),[ve,he]=r.useState(null),[ge,fe]=r.useState(null),[x,B]=r.useState(null),[l,g]=r.useState([]),[U,L]=r.useState(!1),[$,z]=r.useState([]),b=le({resolver:de(ue),defaultValues:{title:"",client_id:"",service_id:"",date:"",start_time:"",notes:"",payment_method:"pix"}}),H=_({queryKey:["/api/provider/appointments"],enabled:!!i&&i.role==="provider"}),f=H.data,W=H.isLoading,c=_({queryKey:["/api/provider/services"],enabled:!!i&&i.role==="provider"});c.data;const J=c.isLoading;r.useEffect(()=>{c.data&&console.log("Serviços carregados:",c.data),c.error&&console.error("Erro ao carregar serviços:",c.error)},[c.data,c.error]);const m=_({queryKey:["/api/provider/clients"],enabled:!!i&&i.role==="provider"});m.data;const X=m.isLoading;r.useEffect(()=>{m.data&&console.log("Clientes carregados:",m.data),m.error&&console.error("Erro ao carregar clientes:",m.error)},[m.data,m.error]),I({mutationFn:async a=>{console.log("Criando agendamento manual:",a);const t={title:a.title,clientId:parseInt(a.client_id),providerId:i==null?void 0:i.id,serviceId:parseInt(a.service_id),date:a.date,startTime:a.start_time,endTime:a.end_time,notes:a.notes||"",status:"confirmado",paymentMethod:a.payment_method,isManuallyCreated:!0};return await(await u("POST","/api/appointments",t)).json()},onSuccess:a=>{console.log("Agendamento criado com sucesso:",a),h.invalidateQueries({queryKey:["/api/provider/appointments"]}),o({title:"Agendamento criado",description:"O agendamento foi criado com sucesso!"}),b.reset()},onError:a=>{console.error("Erro ao criar agendamento:",a),o({title:"Erro ao criar agendamento",description:a.message||"Não foi possível criar o agendamento. Tente novamente.",variant:"destructive"})}}),I({mutationFn:async a=>{console.log("Atualizando agendamento:",a);const{id:t,...s}=a,n={title:s.title,clientId:parseInt(s.client_id),providerId:i==null?void 0:i.id,serviceId:parseInt(s.service_id),date:s.date,startTime:s.start_time,endTime:s.end_time,notes:s.notes||"",paymentMethod:s.payment_method,status:"confirmado"};return await(await u("PUT",`/api/appointments/${t}`,n)).json()},onSuccess:a=>{console.log("Agendamento atualizado com sucesso:",a),h.invalidateQueries({queryKey:["/api/provider/appointments"]}),o({title:"Agendamento atualizado",description:"O agendamento foi atualizado com sucesso!"}),b.reset()},onError:a=>{console.error("Erro ao atualizar agendamento:",a),o({title:"Erro ao atualizar agendamento",description:a.message||"Não foi possível atualizar o agendamento. Tente novamente.",variant:"destructive"})}}),I({mutationFn:async a=>(console.log("Excluindo agendamento:",a),await(await u("DELETE",`/api/appointments/${a}`)).json()),onSuccess:a=>{console.log("Agendamento excluído com sucesso"),h.invalidateQueries({queryKey:["/api/provider/appointments"]}),o({title:"Agendamento excluído",description:"O agendamento foi excluído com sucesso!"}),P(null)},onError:a=>{console.error("Erro ao excluir agendamento:",a),o({title:"Erro ao excluir agendamento",description:a.message||"Não foi possível excluir o agendamento. Tente novamente.",variant:"destructive"})}}),r.useEffect(()=>{if(f&&Array.isArray(f)){const a=f.map(t=>{let s="#10b981",n="#059669",p="#ffffff";t.status==="pendente"?(s="#f59e0b",n="#d97706"):t.status==="cancelado"&&(s="#ef4444",n="#dc2626"),t.isManuallyCreated&&(t.status==="confirmado"?(s="#38bdf8",n="#0284c7"):t.status==="pendente"&&(s="#fb923c",n="#ea580c"));const E=`${t.date}T${t.start_time}`,Z=`${t.date}T${t.end_time}`;return{id:String(t.id),title:t.title,start:E,end:Z,backgroundColor:s,borderColor:n,textColor:p,extendedProps:{client:t.client_name,client_id:t.client_id,service:t.service_name,service_id:t.service_id,status:t.status,notes:t.notes,payment_status:t.payment_status,isManuallyCreated:t.isManuallyCreated||!1}}});V(a)}},[f]);const j=a=>{const t=a.event,s={id:String(t.id),title:t.title,start:t.start,end:t.end,backgroundColor:t.backgroundColor,borderColor:t.borderColor,textColor:t.textColor,extendedProps:t.extendedProps};P(s);const n=d(new Date(t.start),"yyyy-MM-dd"),p=d(new Date(t.start),"HH:mm");b.reset({title:t.title,client_id:String(t.extendedProps.client_id||""),service_id:String(t.extendedProps.service_id||""),date:n,start_time:p,notes:t.extendedProps.notes||"",payment_method:"pix"})},T=async a=>{if(i!=null&&i.id){L(!0);try{const s=await(await u("GET",`/api/provider/${i.id}/availability?date=${d(a,"yyyy-MM-dd")}`)).json();z(Array.isArray(s)?s:[])}catch{z([])}finally{L(!1)}}},w=a=>{B(a.date),g([{startTime:"",endTime:""}]),T(a.date)},C=async a=>{const t=a.event,s=d(new Date(t.start),"yyyy-MM-dd"),n=d(new Date(t.start),"HH:mm"),p=d(new Date(t.end),"HH:mm");console.log("Movendo agendamento:",t.id,{newDate:s,newStartTime:n,newEndTime:p});try{await u("PUT",`/api/appointments/${t.id}`,{date:s,startTime:n,endTime:p}),o({title:"Agendamento atualizado",description:"O agendamento foi movido com sucesso!"}),h.invalidateQueries({queryKey:["/api/provider/appointments"]})}catch(E){console.error("Erro ao mover agendamento:",E),a.revert(),o({title:"Erro ao mover agendamento",description:"Não foi possível mover o agendamento. Tente novamente.",variant:"destructive"})}},q=async a=>{const t=a.event,s=d(new Date(t.end),"HH:mm");console.log("Redimensionando agendamento:",t.id,{newEndTime:s});try{await u("PUT",`/api/appointments/${t.id}`,{endTime:s}),o({title:"Agendamento atualizado",description:"A duração do agendamento foi alterada com sucesso!"}),h.invalidateQueries({queryKey:["/api/provider/appointments"]})}catch(n){console.error("Erro ao redimensionar agendamento:",n),a.revert(),o({title:"Erro ao alterar duração",description:"Não foi possível alterar a duração do agendamento. Tente novamente.",variant:"destructive"})}},Y=async a=>{i!=null&&i.id&&(await u("DELETE",`/api/provider/${i.id}/availability/${a}`),x&&T(x))};if(W||J||X)return e.jsx("div",{className:"flex justify-center items-center h-64",children:"Carregando calendário..."});const N=a=>{const t=a.event,s=t.extendedProps.isManuallyCreated;return e.jsxs("div",{className:"flex flex-col w-full overflow-hidden p-1",children:[e.jsxs("div",{className:"font-semibold text-xs truncate flex items-center",children:[t.title,s&&e.jsx("span",{className:"ml-1 text-[8px] py-0 px-1 rounded bg-white/20 text-white border border-white/30",children:"Manual"})]}),e.jsx("div",{className:"text-[10px] truncate",children:t.extendedProps.client&&e.jsxs("span",{children:["Cliente: ",t.extendedProps.client]})})]})};return e.jsxs("div",{className:"space-y-4",children:[e.jsx(ae,{children:e.jsx(se,{className:"p-0",children:e.jsxs(re,{defaultValue:"week",children:[e.jsx("div",{className:"flex justify-between items-center p-4 border-b",children:e.jsxs(oe,{children:[e.jsx(D,{value:"month",children:"Mês"}),e.jsx(D,{value:"week",children:"Semana"}),e.jsx(D,{value:"day",children:"Dia"})]})}),e.jsxs("div",{className:"p-3 bg-muted/20 flex flex-wrap items-center gap-2 text-xs border-b",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-[#10b981] mr-1"}),e.jsx("span",{children:"Confirmado"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-[#f59e0b] mr-1"}),e.jsx("span",{children:"Pendente"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-[#ef4444] mr-1"}),e.jsx("span",{children:"Cancelado"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-[#38bdf8] mr-1"}),e.jsx("span",{children:"Manual"})]})]}),e.jsx(k,{value:"month",className:"p-0",children:e.jsx("div",{className:"h-[650px] md:h-[750px]",children:e.jsx(S,{plugins:[ne,A],initialView:"dayGridMonth",locale:M,headerToolbar:{left:"prev,next today",center:"title",right:""},events:y,eventClick:j,dateClick:w,editable:!0,droppable:!0,eventDrop:C,eventContent:N,height:"100%"})})}),e.jsx(k,{value:"week",className:"p-0",children:e.jsx("div",{className:"h-[650px] md:h-[750px]",children:e.jsx(S,{plugins:[R,A],initialView:"timeGridWeek",locale:M,headerToolbar:{left:"prev,next today",center:"title",right:""},events:y,eventClick:j,dateClick:w,editable:!0,droppable:!0,eventDrop:C,eventResize:q,eventContent:N,slotDuration:"00:30:00",slotLabelInterval:"01:00",slotMinTime:"07:00:00",slotMaxTime:"22:00:00",allDaySlot:!1,height:"100%"})})}),e.jsx(k,{value:"day",className:"p-0",children:e.jsx("div",{className:"h-[650px] md:h-[750px]",children:e.jsx(S,{plugins:[R,A],initialView:"timeGridDay",locale:M,headerToolbar:{left:"prev,next today",center:"title",right:""},events:y,eventClick:j,dateClick:w,editable:!0,droppable:!0,eventDrop:C,eventResize:q,eventContent:N,slotDuration:"00:15:00",slotLabelInterval:"01:00",slotMinTime:"07:00:00",slotMaxTime:"22:00:00",allDaySlot:!1,height:"100%"})})})]})})}),e.jsx("div",{className:"mt-6 p-4 bg-white rounded shadow border max-w-lg mx-auto",children:x?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-2 font-semibold text-lg text-center",children:["Horários para ",d(x,"dd/MM/yyyy")]}),U?e.jsx("div",{className:"text-center text-gray-500",children:"Carregando horários..."}):e.jsxs(e.Fragment,{children:[$.length>0?e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"font-medium text-sm mb-1",children:"Já cadastrados:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:$.map(a=>e.jsxs("div",{className:"flex items-center gap-2 bg-gray-100 px-3 py-1 rounded",children:[e.jsxs("span",{className:"font-mono",children:[a.startTime," - ",a.endTime]}),e.jsx(K,{size:"sm",variant:"ghost",onClick:()=>Y(a.id),title:"Remover horário",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]},a.id))})]}):e.jsx("div",{className:"mb-3 text-gray-500 text-sm text-center",children:"Nenhum horário cadastrado para este dia."}),e.jsxs("div",{className:"flex items-end gap-2 justify-center",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Início"}),e.jsx(O,{type:"time",value:((Q=l[0])==null?void 0:Q.startTime)||"",onChange:a=>{const t=[...l];t[0].startTime=a.target.value,g(t)},className:"w-28"})]}),e.jsx("span",{className:"pb-2",children:"até"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Fim"}),e.jsx(O,{type:"time",value:((F=l[0])==null?void 0:F.endTime)||"",onChange:a=>{const t=[...l];t[0].endTime=a.target.value,g(t)},className:"w-28"})]}),e.jsx(K,{className:"mb-1",onClick:async()=>{!x||!(i!=null&&i.id)||!l[0].startTime||!l[0].endTime||(await u("POST",`/api/provider/${i.id}/availability`,{date:d(x,"yyyy-MM-dd"),slots:[{startTime:l[0].startTime,endTime:l[0].endTime}]}),g([{startTime:"",endTime:""}]),T(x))},disabled:!l[0].startTime||!l[0].endTime,children:"+ Adicionar horário"})]})]})]}):e.jsx("div",{className:"text-center text-gray-400",children:"Selecione um dia no calendário para gerenciar horários."})})]})},Ae=()=>{const{user:i}=G();return i?e.jsxs("div",{className:"flex flex-col min-h-screen bg-gray-50",children:[e.jsx(ie,{children:e.jsx("title",{children:"Calendário | AgendoAI"})}),e.jsx("main",{className:"flex-1 p-4 md:p-6 pb-20",children:e.jsxs("div",{className:"w-full max-w-7xl mx-auto",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Meu Calendário"}),e.jsx("p",{className:"text-muted-foreground",children:"Gerencie seus agendamentos e horários"})]}),e.jsx(xe,{})]})})]}):e.jsx("div",{children:"Carregando..."})};export{Ae as default};
